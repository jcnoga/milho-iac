<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRA Milho Profissional</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Biblioteca DOCX -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
    <style>
        :root {
            --primary-green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #e8f5e9;
            --accent-color: #43a047;
            --soil-brown: #795548;
        }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        
        /* Layout Principal */
        .header-app {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--primary-green) 100%);
            color: white; padding: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Estilo do Formulário */
        .form-section-title {
            font-size: 1.1rem; font-weight: 700; color: #1b5e20;
            margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;
            text-transform: uppercase;
        }
        .card-custom {
            border: 1px solid #e0e0e0; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            background: white; padding: 25px;
        }
        .form-label { font-weight: 600; font-size: 0.85rem; color: #444; margin-bottom: 3px; }
        .form-control, .form-select { 
            border: 1px solid #ccc; padding: 8px 10px; font-size: 0.95rem; border-radius: 4px; background-color: #fff;
        }
        .form-control:focus, .form-select:focus { 
            border-color: #2e7d32; box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2); 
        }
        .bg-readonly { background-color: #f2f2f2; font-weight: bold; color: #1b5e20; }
        .demo-locked { pointer-events: none; background-color: #e9ecef !important; color: #6c757d; }

        /* Botões */
        .btn-fill-purple { background-color: #6c5ce7; color: white; font-weight: bold; border: none; font-size: 0.9rem; }
        .btn-save-green { background-color: #2e7d32; color: white; font-weight: bold; border-radius: 4px; padding: 10px 30px; border: none; }
        .btn-clean { background-color: #fff; color: #666; border: 1px solid #ccc; font-weight: bold; border-radius: 4px; padding: 10px 30px; }

        /* Auth & Modais */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.98); z-index: 9999;
            display: flex; align-items: center; justify-content: center; overflow-y: auto;
        }
        .auth-card {
            background: white; padding: 2.5rem; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px;
        }

        /* Relatórios */
        .report-box {
            font-family: 'Segoe UI', sans-serif; white-space: pre-wrap; background: #fff;
            border: 1px solid #ced4da; padding: 30px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6;
        }
        .table-tech th { background-color: var(--light-green); color: var(--dark-green); }

        /* Container Oculto Word */
        #exportContent { display: none; }
    </style>
</head>
<body>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="authScreen" class="auth-overlay">
        <div id="loginForm" class="auth-card">
            <div class="text-center mb-4">
                <i class="fas fa-leaf text-success fa-4x"></i>
                <h3 class="fw-bold mt-3">SRA Milho</h3>
                <p class="text-muted">Acesso ao Sistema</p>
            </div>
            <div class="mb-3">
                <label class="form-label">E-mail</label>
                <input type="email" id="loginEmail" class="form-control">
            </div>
            <div class="mb-4">
                <label class="form-label">Senha</label>
                <input type="password" id="loginPass" class="form-control">
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg fw-bold" id="btnLoginAction">ENTRAR</button>
                <button class="btn btn-outline-dark" id="btnGoogleAction"><i class="fab fa-google me-2"></i> Google</button>
            </div>
            <div class="text-center mt-4">
                <a href="#" class="text-decoration-none me-3" onclick="toggleAuth('register')">Criar Conta</a>
                <a href="#" class="text-decoration-none ms-3 text-muted" onclick="toggleAuth('forgot')">Recuperar Senha</a>
            </div>
        </div>
        
        <!-- Cadastro -->
        <div id="registerForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-4">Nova Conta</h4>
            <div class="mb-3"><label>Nome Completo</label><input type="text" id="regName" class="form-control"></div>
            <div class="mb-3"><label>E-mail</label><input type="email" id="regEmail" class="form-control"></div>
            <div class="mb-4"><label>Senha</label><input type="password" id="regPass" class="form-control"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary fw-bold" id="btnRegAction">CADASTRAR</button>
                <button class="btn btn-link" onclick="toggleAuth('login')">Voltar</button>
            </div>
        </div>

        <!-- Recuperar Senha -->
        <div id="forgotForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-3">Recuperar Senha</h4>
            <div class="mb-4"><label>E-mail</label><input type="email" id="forgotEmail" class="form-control"></div>
            <div class="d-grid gap-2"><button class="btn btn-warning text-white fw-bold" id="btnForgotAction">ENVIAR EMAIL</button><button class="btn btn-link" onclick="toggleAuth('login')">Voltar</button></div>
        </div>

        <!-- Token -->
        <div id="tokenForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold text-primary mb-2">Créditos</h4>
            <div class="bg-light p-3 rounded text-center mb-4 border"><h1 class="text-dark m-0" id="displayAuthCode">----</h1></div>
            <div class="mb-3"><input type="text" id="inputToken" class="form-control text-center" placeholder="Senha"></div>
            <div class="d-grid gap-2"><button class="btn btn-success fw-bold" id="btnTokenAction">VALIDAR</button><button class="btn btn-link text-danger" onclick="startUnauthorized()">Modo Demonstração</button></div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="appContainer" style="display: none;">
        
        <header class="header-app sticky-top">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-signature fa-lg me-2"></i>
                    <div>
                        <h5 class="m-0 fw-bold">Amostras de Solo</h5>
                        <small class="text-white-50">Conectado (Firebase)</small>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-white text-success p-2 shadow-sm me-3"><i class="fas fa-coins"></i> <span id="creditCounter">...</span></span>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="openHistoryModal()">Histórico</button>
                    <div class="dropdown me-2">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="fas fa-user"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="userNameDisplay">User</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="showTokenScreen()">Adicionar Créditos</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()">Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mt-4 pb-5">
            <!-- Barra de Status -->
            <div id="statusAlert" class="alert shadow-sm border-2" style="display: none;">
                <div class="d-flex align-items-center">
                    <div class="fs-4 me-3" id="statusIcon"></div>
                    <div><h6 class="fw-bold m-0" id="statusTitle"></h6><p class="m-0 small" id="statusMsg"></p></div>
                    <div class="ms-auto" id="returnBtnContainer" style="display:none;"><button class="btn btn-danger btn-sm" onclick="resetToRealMode()">Cancelar</button></div>
                </div>
            </div>

            <!-- Formulário -->
            <div class="card-custom">
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-fill-purple" onclick="triggerExampleData()">
                        <i class="fas fa-bolt me-1"></i> Preencher Teste
                    </button>
                </div>

                <form id="agronomicForm">
                    <!-- 1. Dados Gerais -->
                    <div class="mb-4">
                        <h5 class="form-section-title">1. Dados Gerais</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">Produtor</label><input type="text" class="form-control" id="ownerName"></div>
                            <div class="col-md-6"><label class="form-label">Propriedade</label><input type="text" class="form-control" id="propName"></div>
                            <div class="col-md-6"><label class="form-label">Município/UF</label><input type="text" class="form-control" id="cityState"></div>
                            <div class="col-md-6"><label class="form-label">Responsável Técnico</label><input type="text" class="form-control" id="techResp"></div>
                            <div class="col-md-12"><label class="form-label">Cultivo Anterior</label><select class="form-select" id="prevCulture"><option value="milho">Milho</option><option value="graminea">Gramínea</option><option value="leguminosa">Leguminosa</option></select></div>
                        </div>
                    </div>

                    <!-- 2. Identificação -->
                    <div class="mb-4">
                        <h5 class="form-section-title">2. Identificação e Cultura</h5>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">Protocolo</label><input type="text" class="form-control" id="protocolId"></div>
                            <div class="col-md-3"><label class="form-label">Talhão</label><input type="text" class="form-control" id="plotId"></div>
                            <div class="col-md-3"><label class="form-label">Profundidade</label><input type="text" class="form-control" value="0-20"></div>
                            <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" id="sampleDate"></div>
                            
                            <div class="col-md-3"><label class="form-label">Cultura</label><select class="form-select" id="cropSeason"><option value="verao">Milho Verão</option><option value="safrinha">Milho Safrinha</option></select></div>
                            <div class="col-md-3"><label class="form-label">Meta (sc/ha)</label><input type="number" class="form-control" id="targetYield"></div>
                            <div class="col-md-3"><label class="form-label">Esp. Linha</label><input type="number" class="form-control" id="rowSpacing" step="0.01"></div>
                            <div class="col-md-3"><label class="form-label">Esp. Cova</label><input type="number" class="form-control" id="plantSpacing" step="0.01"></div>
                            <div class="col-md-12"><label class="form-label">Sistema</label><select class="form-select" id="systemType"><option value="spd_consolidado">SPD</option><option value="conv">Convencional</option></select></div>
                        </div>
                    </div>

                    <!-- 3. Química -->
                    <div class="mb-4">
                        <h5 class="form-section-title">3. Análise Química</h5>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">pH (H₂O)</label><input type="number" class="form-control" id="soilPH" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">M.O. (%)</label><input type="number" class="form-control" id="soilMO" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">P (mg/dm³)</label><input type="number" class="form-control" id="soilP" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">S (mg/dm³)</label><input type="number" class="form-control" id="soilS" step="0.1"></div>
                            
                            <div class="col-md-3"><label class="form-label">Ca (cmolc)</label><input type="number" class="form-control" id="soilCa" step="0.1" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">Mg (cmolc)</label><input type="number" class="form-control" id="soilMg" step="0.1" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">K (cmolc)</label><input type="number" class="form-control" id="soilK" step="0.01" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">H+Al (cmolc)</label><input type="number" class="form-control" id="soilHAl" step="0.1" oninput="calculateComplex()"></div>
                            
                            <div class="col-md-3"><label class="form-label">Al (cmolc)</label><input type="number" class="form-control" id="soilAl" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label bg-readonly">CTC (Calc)</label><input type="number" class="form-control bg-readonly" id="soilCTC" readonly></div>
                            <div class="col-md-3"><label class="form-label bg-readonly">V% (Calc)</label><input type="number" class="form-control bg-readonly" id="soilV" readonly></div>
                            <div class="col-md-3"><label class="form-label">PRNT</label><input type="number" class="form-control" id="limePRNT" value="80"></div>
                        </div>
                    </div>

                    <!-- 4. Física -->
                    <div class="mb-4">
                        <h5 class="form-section-title">4. Física e Micronutrientes</h5>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">Argila %</label><input type="number" class="form-control" id="soilClay" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Areia %</label><input type="number" class="form-control" id="soilSand" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Zn</label><input type="number" class="form-control" id="soilZn" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">B</label><input type="number" class="form-control" id="soilB" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Mn</label><input type="number" class="form-control" id="soilMn" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Cu</label><input type="number" class="form-control" id="soilCu" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Fe</label><input type="number" class="form-control" id="soilFe" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Mo</label><input type="number" class="form-control" id="soilMo" step="0.01"></div>
                        </div>
                    </div>

                    <!-- Híbrido Options -->
                    <div class="d-flex gap-3 mb-3 small text-muted justify-content-center">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="checkSaveCloud" checked><label>Salvar Nuvem</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="checkSaveLocal" checked><label>Salvar Local</label></div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" id="btnCalculate" class="btn-save-green" onclick="generateRecommendation()">Salvar Amostra</button>
                        <button type="button" class="btn-clean" onclick="resetToRealMode()">Limpar</button>
                    </div>
                </form>
            </div>

            <!-- RESULTADOS -->
            <div id="resultsSection" style="display: none;">
                <div class="card-custom border-top border-3 border-success">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-success m-0">Laudo Técnico Gerado</h5>
                        <button class="btn btn-primary btn-sm" onclick="downloadWord()"><i class="fas fa-file-word me-2"></i> Baixar Word (.docx)</button>
                    </div>
                    
                    <ul class="nav nav-pills mb-3" id="pills-tab">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-laudo">Recomendação</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-tabela">Cálculos</button></li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="pills-laudo">
                            <textarea id="finalReportText" class="form-control report-box shadow-sm mb-3" rows="15" readonly></textarea>
                            <div class="d-grid gap-2 d-md-block">
                                <button class="btn btn-success" onclick="shareWhatsapp()"><i class="fab fa-whatsapp me-2"></i> Enviar Whats</button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-tabela">
                            <table class="table table-bordered table-striped text-center small">
                                <thead class="table-light"><tr><th>Item</th><th>Valor</th><th>Unidade</th></tr></thead>
                                <tbody id="techTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTÓRICO -->
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Amostras Salvas (Local)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="localHistoryList" class="list-group"></div></div><div class="modal-footer"><button class="btn btn-sm btn-outline-danger" onclick="clearLocalHistory()">Limpar</button></div></div></div></div>

    <!-- TEMPLATE EXPORTAÇÃO (WORD) -->
    <div id="exportContent">
        <div class="doc-header">
            <h1 class="doc-title" style="color:#2e7d32">LAUDO DE RECOMENDAÇÃO AGRONÔMICA</h1>
            <p>SRA MILHO - IAC 100</p>
        </div>
        <div style="background:#f0f0f0;padding:5px;border-left:5px solid green;margin-top:15px;font-weight:bold">1. IDENTIFICAÇÃO</div>
        <p><strong>Produtor:</strong> <span id="doc_owner"></span> | <strong>Propriedade:</strong> <span id="doc_prop"></span></p>
        <p><strong>Safra:</strong> <span id="doc_season"></span> | <strong>Meta:</strong> <span id="doc_yield"></span> sc/ha</p>
        <p><strong>Solo:</strong> <span id="doc_texture"></span> | <strong>V%:</strong> <span id="doc_v"></span>%</p>
        <div style="background:#f0f0f0;padding:5px;border-left:5px solid green;margin-top:15px;font-weight:bold">2. RECOMENDAÇÃO TÉCNICA</div>
        <div id="doc_body_content" style="white-space: pre-wrap; font-family: Arial, sans-serif;"></div>
        <div style="background:#f0f0f0;padding:5px;border-left:5px solid green;margin-top:15px;font-weight:bold">3. RESUMO ANALÍTICO</div>
        <div id="doc_table_container"></div>
        <p style="text-align:center;font-size:10px;margin-top:30px;border-top:1px solid #ccc;padding-top:5px">Documento gerado pelo SRA.</p>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CHAVES DO FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyB5LjcVrlnBSTQyzbj1PxOFoO176KnHdZs",
  authDomain: "milho-iac.firebaseapp.com",
  projectId: "milho-iac",
  storageBucket: "milho-iac.firebasestorage.app",
  messagingSenderId: "1072500431786",
  appId: "1:1072500431786:web:7b9ac660aa47f6433969d3",
  measurementId: "G-07R2DFGE8T"
};
        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch(e){ console.warn("Firebase config error"); }

        let currentUserData = null;
        let appState = { isDemo: false, isFreeExample: false, generatedCode: null };

        const els = {
            authScreen: document.getElementById('authScreen'), appContainer: document.getElementById('appContainer'),
            loginForm: document.getElementById('loginForm'), regForm: document.getElementById('registerForm'), tokenForm: document.getElementById('tokenForm'), forgotForm: document.getElementById('forgotForm'),
            creditCounter: document.getElementById('creditCounter'), userName: document.getElementById('userNameDisplay'), btnCalc: document.getElementById('btnCalculate')
        };

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if(user){
                const snap = await getDoc(doc(db,"users",user.uid));
                currentUserData = snap.exists() ? snap.data() : {name:user.email.split('@')[0], email:user.email, credits:3};
                if(!snap.exists()) await setDoc(doc(db,"users",user.uid), currentUserData);
                showAppUI();
            } else { currentUserData=null; showAuthUI('login'); }
        });

        window.toggleAuth=(s)=>{ ['loginForm','registerForm','tokenForm','forgotForm'].forEach(i=>document.getElementById(i).style.display='none'); document.getElementById(s+'Form').style.display='block'; };
        window.startUnauthorized=()=>{ appState.isDemo=true; showAppUI(); setStatus("DEMO", "Visualização", "alert-danger", "fa-ban", false); triggerExampleData(); };
        window.handleLogout=()=>{ if(confirm("Sair?")) signOut(auth).then(()=>location.reload()); };

        // Listeners
        document.getElementById('btnLoginAction').addEventListener('click',()=>signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(e=>alert(e.message)));
        document.getElementById('btnRegAction').addEventListener('click',()=>createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value).then(c=>setDoc(doc(db,"users",c.user.uid),{name:document.getElementById('regName').value,email:c.user.email,credits:3})).catch(e=>alert(e.message)));
        document.getElementById('btnGoogleAction').addEventListener('click',()=>signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>console.error(e)));
        document.getElementById('btnForgotAction').addEventListener('click',()=>sendPasswordResetEmail(auth, document.getElementById('forgotEmail').value).then(()=>alert("Verifique e-mail")).catch(e=>alert(e.message)));

        // UI
        function showAppUI(){ els.authScreen.style.display='none'; els.appContainer.style.display='block'; updateHeader(); }
        function showAuthUI(s){ els.authScreen.style.display='flex'; els.appContainer.style.display='none'; toggleAuth(s); }
        function updateHeader(){ 
            els.creditCounter.innerText = appState.isDemo ? "DEMO" : currentUserData?.credits; 
            els.userName.innerText = appState.isDemo ? "Visitante" : currentUserData?.name;
        }

        // Tokens
        window.showTokenScreen = () => { els.appContainer.style.display='none'; els.authScreen.style.display='flex'; toggleAuth('token'); appState.generatedCode=Math.floor(Math.random()*9000)+1000; document.getElementById('displayAuthCode').innerText=appState.generatedCode; };
        document.getElementById('btnTokenAction').addEventListener('click', async()=>{
            const inp = document.getElementById('inputToken').value.replace(/\D/g,'');
            if(inp.length<6) return alert("Inválido");
            const exp = (appState.generatedCode+13)*9+1954;
            if(parseInt(inp.substring(0,5))===exp && parseInt(inp.substring(5))>0) {
                await updateDoc(doc(db,"users",auth.currentUser.uid),{credits:increment(parseInt(inp.substring(5)))});
                currentUserData = (await getDoc(doc(db,"users",auth.currentUser.uid))).data();
                alert("Sucesso!"); showAppUI();
            } else alert("Senha incorreta");
        });

        // --- CÁLCULOS COMPLEXOS (H+Al) ---
        window.calculateComplex = () => {
            const get = id => parseFloat(document.getElementById(id).value)||0;
            const K = get('soilK');
            const Ca = get('soilCa');
            const Mg = get('soilMg');
            const HAl = get('soilHAl');

            const SB = Ca + Mg + K;
            const CTC = SB + HAl;
            const V = CTC > 0 ? (SB / CTC) * 100 : 0;

            document.getElementById('soilCTC').value = CTC.toFixed(2);
            document.getElementById('soilV').value = V.toFixed(1);
        };

        window.triggerExampleData = () => {
            appState.isFreeExample=true; setStatus("SIMULAÇÃO", "Dados fictícios", "alert-warning", "fa-magic", true);
            const r = (min,max)=>(Math.random()*(max-min)+min).toFixed(1);
            const r2 = (min,max)=>(Math.random()*(max-min)+min).toFixed(2);
            
            // Preencher TUDO
            document.getElementById('ownerName').value="Agricultor Exemplo";
            document.getElementById('propName').value="Fazenda Esperança";
            document.getElementById('cityState').value="Uberlândia - MG";
            document.getElementById('techResp').value="Eng. Carlos Silva";
            document.getElementById('protocolId').value="L-2023-99";
            document.getElementById('plotId').value="Talhão A1";
            document.getElementById('sampleDate').value=new Date().toISOString().split('T')[0];
            document.getElementById('targetYield').value=160;
            
            // Quimica
            document.getElementById('soilPH').value=r(4.5, 6.5);
            document.getElementById('soilMO').value=r(1.5, 4.5);
            document.getElementById('soilP').value=r(8, 40);
            document.getElementById('soilS').value=r(5, 15);
            document.getElementById('soilK').value=r2(0.1, 0.6); // cmolc
            document.getElementById('soilCa').value=r(1.5, 5.0);
            document.getElementById('soilMg').value=r(0.5, 2.0);
            document.getElementById('soilHAl').value=r(2.0, 5.0);
            document.getElementById('soilAl').value=r(0, 1.5);
            
            // Fisica e Micro
            document.getElementById('soilClay').value=r(20, 60);
            document.getElementById('soilSand').value=r(10, 40);
            document.getElementById('soilZn').value=r(0.5, 3.0);
            document.getElementById('soilB').value=r(0.2, 0.8);
            document.getElementById('soilMn').value=r(5, 30);
            document.getElementById('soilCu').value=r(0.5, 2.0);
            document.getElementById('soilFe').value=r(15, 60);
            document.getElementById('soilMo').value=r2(0.01, 0.1);

            window.calculateComplex();
            
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el=>{el.readOnly=true; el.classList.add('demo-locked');});
            els.btnCalc.innerHTML="SALVAR (SIMULAÇÃO)";
        };

        window.resetToRealMode = () => {
            appState.isFreeExample=false; document.getElementById('statusAlert').style.display='none';
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el=>{el.readOnly=false; el.classList.remove('demo-locked'); el.value=''; if(el.id==='limePRNT')el.value=80;});
            els.btnCalc.innerHTML='Salvar Amostra';
            document.getElementById('resultsSection').style.display='none';
        };

        // --- GERAÇÃO IAC 100 ---
        document.getElementById('btnCalculate').addEventListener('click', async (e) => {
            const isReal = !appState.isDemo && !appState.isFreeExample;
            if(isReal) {
                if(!currentUserData || currentUserData.credits<=0) return alert("Sem créditos.");
                try { await updateDoc(doc(db,"users",auth.currentUser.uid),{credits:increment(-1)}); currentUserData.credits--; updateHeader(); } catch(e){return alert("Erro rede");}
            }

            const get = id => parseFloat(document.getElementById(id).value)||0;
            const data = {
                owner: document.getElementById('ownerName').value,
                prop: document.getElementById('propName').value,
                season: document.getElementById('cropSeason').value,
                yield: get('targetYield'),
                clay: get('soilClay'), P: get('soilP'),
                K: get('soilK') * 10, // cmolc -> mmolc
                V: get('soilV'), CTC: get('soilCTC') * 10, 
                PRNT: get('limePRNT')||100, Mg: get('soilMg') * 10
            };

            let nc = Math.max(0, data.V < 70 ? ((70 - data.V) * data.CTC) / (10 * data.PRNT) : 0);
            let lime = data.Mg < 5 ? "Dolomítico" : "Calcítico";
            let tex = data.clay<=20 ? "Arenosa" : (data.clay<=60 ? "Média" : "Argilosa");
            let recN = data.season==='safrinha' ? 0.8*(data.yield*1.1) : data.yield*1.2;
            let recP = data.P < 15 ? 100 : (data.P < 40 ? 60 : 20);
            let recK = data.K < 1.5 ? 100 : (data.K < 3.0 ? 60 : 20);
            if(data.season==='safrinha') recK *= 0.8;

            const map = recP/0.52, kcl = recK/0.60, urea = Math.max(0, recN-(map*0.11))/0.45, gesso = data.clay*50/1000;

            const laudo = `LAUDO TÉCNICO DE RECOMENDAÇÃO\nBase: IAC 100 (2022)\nData: ${new Date().toLocaleDateString()}\n------------------------------\nPRODUTOR: ${data.owner} | ${data.prop}\nSAFRA: ${data.season.toUpperCase()} | META: ${data.yield} sc/ha\nSOLO: ${tex} (${data.clay}% Argila) | V%: ${data.V}\n\n1. CORREÇÃO\n> CALAGEM: ${nc.toFixed(1)} t/ha Calcário ${lime} (V% 70)\n> GESSAGEM: ${gesso.toFixed(1)} t/ha\n\n2. ADUBAÇÃO (N-P-K)\nNecessidade: N ${recN.toFixed(0)} | P2O5 ${recP} | K2O ${recK.toFixed(0)} kg/ha\n\nMANEJO:\nA) PLANTIO: ${Math.round(map)} kg/ha MAP + ${Math.round(kcl/2)} kg/ha KCl\nB) COBERTURA: ${Math.round(urea)} kg/ha Ureia + ${Math.round(kcl/2)} kg/ha KCl\n\nSRA Milho`;

            document.getElementById('resultsSection').style.display='block';
            document.getElementById('finalReportText').value=laudo;
            document.getElementById('techTableBody').innerHTML=`<tr><td>Calagem</td><td>${nc.toFixed(1)}</td><td>t/ha</td></tr><tr><td>Gesso</td><td>${gesso.toFixed(1)}</td><td>t/ha</td></tr><tr><td>MAP</td><td>${Math.round(map)}</td><td>kg/ha</td></tr><tr><td>Ureia</td><td>${Math.round(urea)}</td><td>kg/ha</td></tr>`;
            document.getElementById('resultsSection').scrollIntoView({behavior:'smooth'});

            // Export Data
            document.getElementById('doc_owner').innerText = data.owner;
            document.getElementById('doc_prop').innerText = data.prop;
            document.getElementById('doc_season').innerText = data.season;
            document.getElementById('doc_yield').innerText = data.yield;
            document.getElementById('doc_texture').innerText = tex;
            document.getElementById('doc_v').innerText = data.V;
            document.getElementById('doc_body_content').innerText = laudo.split("1. CORREÇÃO")[1];
            document.getElementById('doc_table_container').innerHTML = `<table class="doc-table"><thead><tr><th>Item</th><th>Valor</th><th>Unid</th></tr></thead><tbody>${document.getElementById('techTableBody').innerHTML}</tbody></table>`;

            // Save
            const rObj = {date:new Date().toISOString(), owner:data.owner, result:laudo};
            if(isReal && document.getElementById('checkSaveCloud').checked) try{await addDoc(collection(db,"users",auth.currentUser.uid,"reports"),{...rObj,timestamp:serverTimestamp()});}catch(e){}
            if(document.getElementById('checkSaveLocal').checked){ const h=JSON.parse(localStorage.getItem('sra_local_history'))||[]; h.unshift(rObj); localStorage.setItem('sra_local_history',JSON.stringify(h)); }
        };

        // Utils
        function setStatus(t,m,c,i,r){const e=document.getElementById('statusAlert');e.className=`alert shadow-sm ${c}`;e.style.display='block';document.getElementById('statusTitle').innerText=t;document.getElementById('statusMsg').innerText=m;document.getElementById('statusIcon').innerHTML=`<i class="fas ${i}"></i>`;document.getElementById('returnBtnContainer').style.display=r?'block':'none';}
        window.shareWhatsapp=()=>window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('finalReportText').value)}`);
        
        window.openHistoryModal=()=>{
            const l=document.getElementById('localHistoryList'), d=JSON.parse(localStorage.getItem('sra_local_history'))||[];
            l.innerHTML=''; if(!d.length)l.innerHTML='<div class="p-3 text-center text-muted">Vazio</div>';
            else d.forEach(i=>{ const x=document.createElement('div'); x.className="list-group-item list-group-item-action"; x.innerHTML=`<b>${i.owner}</b> <small>${new Date(i.date).toLocaleDateString()}</small>`; x.onclick=()=>{document.getElementById('finalReportText').value=i.result; document.getElementById('resultsSection').style.display='block'; bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();}; l.appendChild(x); });
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        };
        window.clearLocalHistory=()=>{ if(confirm("Apagar?")){localStorage.removeItem('sra_local_history'); window.openHistoryModal();} };

        // Export DOCX (.docx real)
        window.downloadWord = () => {
            const content = document.getElementById('exportContent').innerHTML;
            const htmlContent = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>body{font-family:'Calibri',sans-serif;font-size:11pt} h1{color:#2e7d32;font-size:16pt;margin-bottom:5px} p{margin-bottom:10px} table{width:100%;border-collapse:collapse;margin-top:15px} th,td{border:1px solid #ccc;padding:5px;text-align:center} th{background-color:#f2f2f2}</style></head><body>${content}</body></html>`;
            if (typeof htmlDocx !== 'undefined') {
                const converted = htmlDocx.asBlob(htmlContent);
                const link = document.createElement('a'); link.href = URL.createObjectURL(converted);
                link.download = `Laudo_${document.getElementById('ownerName').value || 'SRA'}.docx`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else { alert("Erro ao carregar biblioteca DOCX. Verifique a internet."); }
        };

    </script>
</body>
</html>