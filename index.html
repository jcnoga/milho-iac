<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRA Milho Profissional - Sistema Completo</title>
    
    <!-- SEGURANÇA: Bloqueio de execução via protocolo file:// -->
    <script>
        if (window.location.protocol === "file:") {
            alert("Por motivos de segurança, esta aplicação não pode ser executada diretamente do sistema de arquivos.\n\nPor favor, utilize um servidor local (localhost) ou a versão hospedada.");
            document.documentElement.innerHTML = ""; // Limpa o conteúdo para impedir uso
            throw new Error("Execução local bloqueada.");
        }
    </script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- html-docx-js para geração de DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
    <!-- html2pdf.js para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary-green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #e8f5e9;
            --accent-color: #43a047;
            --soil-brown: #795548;
        }
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        
        /* Layout Principal */
        .header-app {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--primary-green) 100%);
            color: white; padding: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .card-custom {
            border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px; background: white; transition: transform 0.2s;
        }
        .section-header {
            background-color: var(--light-green); color: var(--dark-green);
            padding: 12px 20px; font-weight: 700; display: flex; align-items: center;
            border-radius: 12px 12px 0 0; border-bottom: 2px solid rgba(46, 125, 50, 0.1);
        }
        
        /* Formulários */
        .form-label { font-weight: 600; font-size: 0.9rem; color: #555; margin-bottom: 4px; }
        .form-control, .form-select { border: 1px solid #ccc; padding: 10px; border-radius: 6px; }
        .form-control:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.15); }
        .demo-locked { pointer-events: none; background-color: #e9ecef !important; color: #6c757d; }

        /* Login & Modais */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.98); z-index: 9999;
            display: flex; align-items: center; justify-content: center; overflow-y: auto;
        }
        .auth-card {
            background: white; padding: 2.5rem; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 480px;
        }

        /* Loading Overlay para Geração de PDF */
        #pdfLoadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 1); z-index: 10000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }

        /* Relatórios Tela */
        .report-box {
            font-family: 'Segoe UI', sans-serif; white-space: pre-wrap; background: #fff;
            border: 1px solid #ced4da; padding: 30px; border-radius: 8px;
            font-size: 0.95rem; line-height: 1.6; color: #212529;
        }
        .table-tech th { background-color: var(--light-green); color: var(--dark-green); }

        /* --- ESTILOS DO DOCUMENTO EXPORTADO (WORD/PDF) --- */
        #exportContent { display: none; }
        
        .doc-header { border-bottom: 3px solid #2e7d32; margin-bottom: 20px; padding-bottom: 10px; }
        .doc-title { font-size: 24px; font-weight: bold; color: #2e7d32; margin: 0; }
        .doc-subtitle { font-size: 12px; color: #555; margin-top: 5px; }
        .doc-section-title { 
            background-color: #e8f5e9; color: #1b5e20; padding: 8px; 
            font-weight: bold; font-size: 14px; margin-top: 20px; margin-bottom: 10px;
            border-left: 5px solid #1b5e20; 
        }
        .doc-text { font-size: 12px; margin-bottom: 10px; text-align: justify; line-height: 1.5; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .doc-table th { background-color: #e8f5e9; border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: center; }
        .doc-table td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: center; }
        .doc-footer { 
            margin-top: 50px; padding-top: 10px; border-top: 1px solid #ccc; 
            text-align: center; font-size: 10px; color: #999; 
        }
    </style>
</head>
<body>

    <!-- OVERLAY DE CARREGAMENTO -->
    <div id="pdfLoadingOverlay">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 fw-bold text-dark">Gerando PDF para visualização...</h5>
        <p class="text-muted">Por favor, aguarde.</p>
    </div>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="authScreen" class="auth-overlay">
        <!-- Login -->
        <div id="loginForm" class="auth-card">
            <div class="text-center mb-4">
                <i class="fas fa-database text-success fa-4x"></i>
                <h3 class="fw-bold mt-3">SRA Milho</h3>
                <p class="text-muted">Sistema Profissional Híbrido</p>
            </div>
            <div class="mb-3">
                <label class="form-label">E-mail</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="seu@email.com">
            </div>
            <div class="mb-4">
                <label class="form-label">Senha</label>
                <input type="password" id="loginPass" class="form-control">
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg fw-bold" id="btnLoginAction">ENTRAR</button>
                <button class="btn btn-outline-dark" id="btnGoogleAction"><i class="fab fa-google me-2"></i> Entrar com Google</button>
            </div>
            <div class="text-center mt-4">
                <a href="#" class="text-decoration-none me-3" onclick="toggleAuth('register')">Criar Conta</a>
                <span class="text-muted">|</span>
                <a href="#" class="text-decoration-none ms-3 text-muted" onclick="toggleAuth('forgot')">Esqueci a Senha</a>
            </div>
        </div>
        
        <!-- Cadastro -->
        <div id="registerForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-4">Nova Conta</h4>
            <div class="mb-3"><label>Nome Completo</label><input type="text" id="regName" class="form-control"></div>
            <div class="mb-3"><label>E-mail</label><input type="email" id="regEmail" class="form-control"></div>
            <div class="mb-4"><label>Senha</label><input type="password" id="regPass" class="form-control"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary fw-bold" id="btnRegAction">CADASTRAR</button>
                <button class="btn btn-link text-secondary" onclick="toggleAuth('login')">Voltar ao Login</button>
            </div>
        </div>

        <!-- Recuperar Senha -->
        <div id="forgotForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-3">Recuperar Senha</h4>
            <div class="mb-4"><label>E-mail cadastrado</label><input type="email" id="forgotEmail" class="form-control"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-warning fw-bold text-white" id="btnForgotAction">ENVIAR EMAIL</button>
                <button class="btn btn-link text-secondary" onclick="toggleAuth('login')">Voltar</button>
            </div>
        </div>

        <!-- Token de Créditos -->
        <div id="tokenForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold text-primary mb-2">Adicionar Créditos</h4>
            
            <!-- Link do WhatsApp para Suporte -->
            <p class="text-center small text-muted">
                <!-- O href será atualizado dinamicamente via JS com o código gerado -->
                <a id="whatsappLink" href="#" target="_blank" class="text-decoration-none text-success fw-bold">
                    <i class="fab fa-whatsapp"></i> Envie o código para o suporte (WhatsApp) 34-99782-4990
                </a>
            </p>

            <div class="bg-light p-3 rounded text-center mb-4 border border-primary">
                <span class="d-block small text-uppercase fw-bold text-muted">Código de Segurança</span>
                <h1 class="text-dark fw-bold m-0 display-4" id="displayAuthCode">----</h1>
            </div>
            <div class="mb-3">
                <label class="form-label">Senha de Liberação</label>
                <input type="text" id="inputToken" class="form-control text-center form-control-lg" placeholder="cole sua senha aqui: Senha-XX">
                <div class="form-text text-center text-muted small mt-2">Exemplo: 1234-05 (Senha-Quantidade)</div>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg fw-bold" id="btnTokenAction">VALIDAR CRÉDITOS</button>
                <button class="btn btn-link text-danger" onclick="startUnauthorized()">Acessar Modo Demonstração</button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="appContainer" style="display: none;">
        
        <header class="header-app sticky-top">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tractor fa-2x me-3"></i>
                    <div>
                        <h5 class="m-0 fw-bold">SRA Milho Profissional</h5>
                        <small class="text-white-50">IAC 100 (2022)</small>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    
                    <!-- Contador e Aviso de Créditos -->
                    <div class="d-flex flex-column align-items-end me-3">
                        <span class="badge bg-white text-success p-2 shadow-sm">
                            <i class="fas fa-coins"></i> <span id="creditCounter" class="fw-bold">...</span>
                        </span>
                        <small id="lowCreditWarning" class="fw-bold mt-1" style="display:none; color: #ffd54f; font-size: 11px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            Seus créditos estão acabando
                        </small>
                    </div>
                    
                    <button class="btn btn-outline-light btn-sm me-2 fw-bold" onclick="openHistoryModal()">
                        <i class="fas fa-history"></i> Histórico
                    </button>

                    <div class="dropdown me-2">
                        <button class="btn btn-sm btn-light dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> <span id="userNameDisplay">Usuário</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="showTokenScreen()"><i class="fas fa-plus-circle me-2"></i>Comprar Créditos</a></li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-sm btn-danger fw-bold ms-2" onclick="handleLogout()" title="Sair do Sistema">
                        <i class="fas fa-sign-out-alt"></i> SAIR
                    </button>
                </div>
            </div>
        </header>

        <div class="container mt-4 pb-5">
            
            <!-- Barra de Status (Simulação/Demo) -->
            <div id="statusAlert" class="alert shadow-sm border-2" style="display: none;">
                <div class="d-flex align-items-center">
                    <div class="fs-2 me-3" id="statusIcon"></div>
                    <div>
                        <h6 class="fw-bold m-0" id="statusTitle"></h6>
                        <p class="m-0 small" id="statusMsg"></p>
                    </div>
                    <div class="ms-auto" id="returnBtnContainer" style="display:none;">
                        <button class="btn btn-danger btn-sm fw-bold" onclick="resetToRealMode()">
                            <i class="fas fa-times me-1"></i> Cancelar Simulação
                        </button>
                    </div>
                </div>
            </div>

            <!-- Formulário Agronômico -->
            <form id="agronomicForm">
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-outline-primary fw-bold btn-sm" onclick="triggerExampleData()">
                        <i class="fas fa-magic me-2"></i> Simulação Grátis
                    </button>
                </div>

                <!-- 1. Identificação -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-id-card me-2"></i> 1. Identificação</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-5"><label class="form-label">Produtor</label><input type="text" class="form-control" id="ownerName"></div>
                            <div class="col-md-5"><label class="form-label">Propriedade</label><input type="text" class="form-control" id="propName"></div>
                            <div class="col-md-2"><label class="form-label">Protocolo</label><input type="text" class="form-control" id="protocolId"></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Sistema -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-seedling me-2"></i> 2. Sistema de Produção</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">Safra</label><select id="cropSeason" class="form-select"><option value="verao">Verão (Safra)</option><option value="safrinha">Safrinha</option></select></div>
                            <div class="col-md-3"><label class="form-label">Meta (sc/ha)</label><input type="number" id="targetYield" class="form-control" placeholder="Ex: 150"></div>
                            <div class="col-md-3"><label class="form-label">Cultura Anterior</label><select id="prevCulture" class="form-select"><option value="graminea">Gramínea/Pastagem</option><option value="milho">Milho</option><option value="leguminosa">Leguminosa (Soja)</option></select></div>
                            <div class="col-md-3"><label class="form-label">Sistema</label><select id="systemType" class="form-select"><option value="spd_consolidado">Plantio Direto</option><option value="conv">Convencional</option></select></div>
                        </div>
                    </div>
                </div>

                <!-- 3. Solo -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-flask me-2"></i> 3. Análise de Solo (0-20 cm)</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12"><h6 class="text-muted border-bottom pb-2 mb-3">Física e Química Básica</h6></div>
                            <div class="col-md-3"><label class="form-label">Argila (%)</label><input type="number" class="form-control" id="soilClay" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">P-resina (mg/dm³)</label><input type="number" class="form-control" id="soilP" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">K (mmolc/dm³)</label><input type="number" class="form-control" id="soilK" step="0.1" oninput="calculateSB()"></div>
                            <div class="col-md-3"><label class="form-label">Ca (mmolc/dm³)</label><input type="number" class="form-control" id="soilCa" step="0.1" oninput="calculateSB()"></div>
                            
                            <div class="col-12"><h6 class="text-muted border-bottom pb-2 mb-3 mt-3">Complexo de Troca</h6></div>
                            <div class="col-md-3"><label class="form-label">Mg (mmolc/dm³)</label><input type="number" class="form-control" id="soilMg" step="0.1" oninput="calculateSB()"></div>
                            <div class="col-md-3"><label class="form-label">Na (mmolc/dm³)</label><input type="number" class="form-control" id="soilNa" value="0" step="0.1" oninput="calculateSB()"></div>
                            <div class="col-md-3"><label class="form-label bg-light border p-2 rounded">SB (Calculada)</label><input type="number" class="form-control bg-light fw-bold" id="soilSB" readonly></div>
                            <div class="col-md-3"><label class="form-label">CTC pH 7</label><input type="number" class="form-control" id="soilCTC" step="0.1"></div>
                            
                            <div class="col-md-3 mt-3"><label class="form-label fw-bold text-success">V% (Saturação)</label><input type="number" class="form-control border-success" id="soilV" step="0.1"></div>
                            <div class="col-md-3 mt-3"><label class="form-label">PRNT Calcário</label><input type="number" class="form-control" id="limePRNT" value="80"></div>

                            <!-- NOVOS CAMPOS: MICRONUTRIENTES (OPCIONAIS) -->
                            <div class="col-12"><h6 class="text-muted border-bottom pb-2 mb-3 mt-3">Micronutrientes (Opcional)</h6></div>
                            <div class="col-md-3"><label class="form-label">Zinco (Zn) mg/dm³</label><input type="number" class="form-control" id="soilZn" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Boro (B) mg/dm³</label><input type="number" class="form-control" id="soilB" step="0.01"></div>
                        </div>
                    </div>
                </div>

                <!-- Painel Híbrido -->
                <div class="card card-custom bg-light border-0">
                    <div class="card-body p-3 d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-2 mb-md-0">
                            <h6 class="fw-bold text-muted mb-1"><i class="fas fa-server me-2"></i>Armazenamento de Dados</h6>
                            <small>Selecione onde deseja salvar este laudo:</small>
                        </div>
                        <div class="d-flex gap-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkSaveCloud" checked>
                                <label class="form-check-label fw-bold text-primary" for="checkSaveCloud">Nuvem (Firebase)</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkSaveLocal" checked>
                                <label class="form-check-label fw-bold text-secondary" for="checkSaveLocal">Local (Navegador)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid mb-5">
                    <button type="button" id="btnCalculate" class="btn btn-success btn-lg shadow fw-bold p-3">
                        <i class="fas fa-check-circle me-2"></i> CALCULAR E GERAR LAUDO
                    </button>
                </div>
            </form>

            <!-- RESULTADOS -->
            <div id="resultsSection" style="display: none;">
                <div class="card card-custom border-2 border-success">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="m-0"><i class="fas fa-file-contract me-2"></i>Laudo Técnico Final</h5>
                        <small>Gerado com Sucesso</small>
                    </div>
                    <div class="card-body p-4">
                        <ul class="nav nav-pills mb-3" id="pills-tab">
                            <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#pills-laudo">Laudo Descritivo</button></li>
                            <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-tabela">Tabela Técnica</button></li>
                        </ul>

                        <div class="tab-content">
                            <!-- Texto -->
                            <div class="tab-pane fade show active" id="pills-laudo">
                                <textarea id="finalReportText" class="form-control report-box shadow-sm mb-4" rows="20" readonly></textarea>
                                <div class="row g-2">
                                    <div class="col-md-6"><button class="btn btn-success w-100 fw-bold py-3" onclick="shareWhatsapp()"><i class="fab fa-whatsapp me-2"></i> WhatsApp</button></div>
                                    <div class="col-md-6"><button class="btn btn-primary w-100 fw-bold py-3" onclick="downloadWord()"><i class="fas fa-file-word me-2"></i> Baixar Word (.docx)</button></div>
                                    <div class="col-md-6"><button class="btn btn-secondary w-100 fw-bold py-2" onclick="sendEmail()"><i class="fas fa-envelope me-2"></i> Enviar por E-mail</button></div>
                                    <!-- Botão PDF -->
                                    <div class="col-md-6"><button class="btn btn-danger w-100 fw-bold py-2" onclick="openPdfPreview()"><i class="fas fa-eye me-2"></i> Visualizar em Tela (PDF)</button></div>
                                </div>
                            </div>
                            <!-- Tabela -->
                            <div class="tab-pane fade" id="pills-tabela">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped text-center table-hover table-tech">
                                        <thead class="table-success"><tr><th>Parâmetro</th><th>Valor Calculado</th><th>Unidade</th></tr></thead>
                                        <tbody id="techTableBody"></tbody>
                                    </table>
                                </div>
                                <div class="alert alert-info mt-3"><i class="fas fa-info-circle me-2"></i> Cálculos baseados integralmente no Boletim Técnico 100 do IAC.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTÓRICO LOCAL -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="fas fa-hdd me-2"></i>Histórico Local (Offline)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="localHistoryList" class="list-group">
                        <div class="text-center text-muted p-3">Nenhum laudo salvo localmente ainda.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-danger btn-sm" onclick="clearLocalHistory()">Limpar Tudo</button>
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL DE VISUALIZAÇÃO DE PDF -->
    <div class="modal fade" id="pdfPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-file-pdf me-2"></i>Visualização do Laudo PDF</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 bg-light d-flex justify-content-center align-items-center">
                    <!-- Iframe para mostrar o PDF -->
                    <iframe id="pdfPreviewFrame" width="100%" height="100%" style="border:none;"></iframe>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="downloadPdfFromPreview()">
                        <i class="fas fa-download me-2"></i> Baixar Arquivo PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TEMPLATE OCULTO PARA EXPORTAÇÃO DOC/PDF -->
    <!-- Conteúdo será injetado dinamicamente -->
    <div id="exportContent"></div>

    <!-- LÓGICA DO SISTEMA -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // --- FIREBASE IMPORT ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==============================================================
        // ATENÇÃO: SUBSTITUA PELAS SUAS CHAVES DO FIREBASE ABAIXO
        // ==============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyB5LjcVrlnBSTQyzbj1PxOFoO176KnHdZs",
          authDomain: "milho-iac.firebaseapp.com",
          projectId: "milho-iac",
          storageBucket: "milho-iac.firebasestorage.app",
          messagingSenderId: "1072500431786",
          appId: "1:1072500431786:web:7b9ac660aa47f6433969d3",
          measurementId: "G-07R2DFGE8T"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.warn("Firebase não configurado. Adicione suas chaves no código.");
        }

        // --- SEGURANÇA: FUNÇÃO DE SANITIZAÇÃO DE HTML (XSS PREVENTION) ---
        function escapeHtml(text) {
            if (!text) return "";
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // --- VARIÁVEIS GLOBAIS ---
        let currentUserData = null;
        let appState = { generatedCode: null, isDemo: false, isFreeExample: false, currentSamplePaid: false };
        let currentPdfBlobUrl = null;

        const els = {
            authScreen: document.getElementById('authScreen'),
            appContainer: document.getElementById('appContainer'),
            loginForm: document.getElementById('loginForm'),
            regForm: document.getElementById('registerForm'),
            tokenForm: document.getElementById('tokenForm'),
            forgotForm: document.getElementById('forgotForm'),
            creditBadges: document.getElementById('creditCounter'),
            userNameDisplay: document.getElementById('userNameDisplay'),
            btnCalc: document.getElementById('btnCalculate')
        };

        // --- AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) currentUserData = userSnap.data();
                else {
                    // ALTERAÇÃO: Créditos iniciais definidos para 50
                    currentUserData = { name: user.displayName || user.email.split('@')[0], email: user.email, credits: 50 };
                    await setDoc(userRef, currentUserData);
                }
                showAppUI();
            } else {
                currentUserData = null;
                showAuthUI('login');
            }
        });

        window.toggleAuth = (screen) => {
            els.loginForm.style.display = 'none';
            els.regForm.style.display = 'none';
            els.tokenForm.style.display = 'none';
            els.forgotForm.style.display = 'none';
            if(screen === 'login') els.loginForm.style.display = 'block';
            if(screen === 'register') els.regForm.style.display = 'block';
            if(screen === 'forgot') els.forgotForm.style.display = 'block';
        };

        window.startUnauthorized = () => {
            appState.isDemo = true;
            showAppUI();
            setStatus("MODO DEMONSTRAÇÃO", "Sem conexão/créditos. Dados visuais apenas.", "alert-danger", "fa-ban", false);
            triggerExampleData();
        };

        window.handleLogout = () => {
            if(confirm("Deseja realmente sair?")) signOut(auth).then(() => location.reload());
        };

        // Listeners Auth
        document.getElementById('btnLoginAction').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value)
            .catch(err => alert("Erro no Login: " + err.message));
        });
        document.getElementById('btnRegAction').addEventListener('click', () => {
            // ALTERAÇÃO: Ao cadastrar, define créditos iniciais como 50
            createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value)
            .then(cred => setDoc(doc(db, "users", cred.user.uid), { name: document.getElementById('regName').value, email: cred.user.email, credits: 50 }))
            .catch(err => alert("Erro no Cadastro: " + err.message));
        });
        document.getElementById('btnGoogleAction').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err));
        });
        document.getElementById('btnForgotAction').addEventListener('click', () => {
            sendPasswordResetEmail(auth, document.getElementById('forgotEmail').value)
            .then(() => alert("E-mail de redefinição enviado! Verifique sua caixa de entrada."))
            .catch(err => alert("Erro: " + err.message));
        });

        // --- UI ---
        function showAppUI() {
            els.authScreen.style.display = 'none';
            els.appContainer.style.display = 'block';
            updateHeader();
        }
        function showAuthUI(screen) {
            els.authScreen.style.display = 'flex';
            els.appContainer.style.display = 'none';
            toggleAuth(screen);
        }
        function updateHeader() {
            if (appState.isDemo) {
                els.creditBadges.innerText = "DEMO";
                els.userNameDisplay.innerText = "Visitante";
                document.getElementById('lowCreditWarning').style.display = 'none';
            } else if (currentUserData) {
                els.creditBadges.innerText = currentUserData.credits;
                els.userNameDisplay.innerText = currentUserData.name;
                
                // Aviso de Créditos Acabando
                const warningEl = document.getElementById('lowCreditWarning');
                if(currentUserData.credits < 3) {
                    warningEl.style.display = 'block';
                } else {
                    warningEl.style.display = 'none';
                }
            }
        }

        // --- CRÉDITOS (TOKEN) ---
        window.showTokenScreen = () => {
            els.appContainer.style.display = 'none';
            els.authScreen.style.display = 'flex';
            toggleAuth('token');
            document.getElementById('tokenForm').style.display = 'block';
            appState.generatedCode = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('displayAuthCode').innerText = appState.generatedCode;

            // ATUALIZA O LINK DO WHATSAPP COM A MENSAGEM DINÂMICA
            const baseMsg = `Olá, desejo adquirir créditos para recomendação. Código para referência: ${appState.generatedCode}__`;
            const encodedMsg = encodeURIComponent(baseMsg);
            document.getElementById('whatsappLink').href = `https://wa.me/5534997824990?text=${encodedMsg}`;
        };

        document.getElementById('btnTokenAction').addEventListener('click', async () => {
            const input = document.getElementById('inputToken').value.replace(/\D/g, '');
            if(input.length < 6) return alert("Código inválido");
            const hash = parseInt(input.substring(0, 5));
            const qtd = parseInt(input.substring(5));
            const expected = (appState.generatedCode + 13) * 9 + 1954;

            if (hash === expected && qtd > 0 && auth.currentUser) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { credits: increment(qtd) });
                const snap = await getDoc(doc(db, "users", auth.currentUser.uid));
                currentUserData = snap.data();
                alert("Créditos adicionados com sucesso!");
                showAppUI();
            } else {
                alert("Senha incorreta.");
            }
        });

        // --- LÓGICA AGRONÔMICA IAC 100 COMPLETA (RESTAURADA) ---
        
        window.calculateSB = () => {
            const vals = ['soilCa', 'soilMg', 'soilK', 'soilNa'].map(id => parseFloat(document.getElementById(id).value)||0);
            document.getElementById('soilSB').value = vals.reduce((a,b)=>a+b,0).toFixed(2);
        };

        window.triggerExampleData = () => {
            appState.isFreeExample = true;
            appState.currentSamplePaid = false; // Reset just in case
            setStatus("SIMULAÇÃO GRÁTIS", "Dados fictícios gerados. Não consome créditos.", "alert-warning", "fa-magic", true);
            const rnd = (min,max) => (Math.random()*(max-min)+min).toFixed(1);
            
            document.getElementById('ownerName').value = "Produtor Exemplo";
            document.getElementById('propName').value = "Sítio Modelo";
            document.getElementById('targetYield').value = Math.floor(rnd(120, 180));
            document.getElementById('soilClay').value = rnd(15, 65);
            document.getElementById('soilP').value = rnd(5, 45);
            document.getElementById('soilK').value = rnd(1, 5);
            document.getElementById('soilCa').value = rnd(20, 50);
            document.getElementById('soilMg').value = rnd(4, 12);
            document.getElementById('soilCTC').value = rnd(60, 110);
            document.getElementById('soilV').value = rnd(30, 65);
            
            // --- Preenchimento Específico ---
            document.getElementById('cropSeason').value = 'verao';
            document.getElementById('prevCulture').value = 'milho';
            document.getElementById('systemType').value = 'conv';
            
            // NOVOS CAMPOS AUTOMÁTICOS
            document.getElementById('soilZn').value = rnd(0.5, 5.0);
            document.getElementById('soilB').value = rnd(0.1, 1.0);
            // --------------------------------------------------------

            window.calculateSB();
            
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el => { 
                el.readOnly = true; el.classList.add('demo-locked');
                if(el.tagName === 'SELECT') el.disabled = true;
            });
            els.btnCalc.innerHTML = '<i class="fas fa-calculator me-2"></i> SIMULAR (GRÁTIS)';
            els.btnCalc.classList.replace('btn-success', 'btn-warning');
        };

        window.resetToRealMode = () => {
            appState.isFreeExample = false;
            appState.currentSamplePaid = false; // RESET FLAG
            document.getElementById('statusAlert').style.display = 'none';
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el => { 
                el.readOnly = false; el.classList.remove('demo-locked'); el.value = ''; 
                if(el.tagName === 'SELECT') el.disabled = false;
                if(el.id === 'limePRNT') el.value = 80;
            });
            els.btnCalc.innerHTML = '<i class="fas fa-check-circle me-2"></i> CALCULAR E GERAR LAUDO';
            els.btnCalc.classList.replace('btn-warning', 'btn-success');
            document.getElementById('resultsSection').style.display = 'none';
        };

        document.getElementById('btnCalculate').addEventListener('click', async (e) => {
            e.preventDefault();

            // --- VALIDAÇÃO DE ZEROS (APENAS P, Ca, Mg continuam obrigatórios) ---
            const vP = parseFloat(document.getElementById('soilP').value) || 0;
            const vCa = parseFloat(document.getElementById('soilCa').value) || 0;
            const vMg = parseFloat(document.getElementById('soilMg').value) || 0;

            if (vP === 0 || vCa === 0 || vMg === 0) {
                alert("Atenção: Os valores de Fósforo (P), Cálcio (Ca) e Magnésio (Mg) são obrigatórios e não podem ser zero para o cálculo.");
                return;
            }
            
            const isReal = !appState.isDemo && !appState.isFreeExample;
            
            if (isReal) {
                if (!auth.currentUser || !currentUserData) return alert("Faça login novamente.");
                
                // ONLY DEDUCT IF NOT ALREADY PAID FOR THIS SESSION
                if (!appState.currentSamplePaid) {
                    if (currentUserData.credits <= 0) return alert("Saldo insuficiente. Adicione créditos.");
                    try {
                        await updateDoc(doc(db, "users", auth.currentUser.uid), { credits: increment(-1) });
                        currentUserData.credits--;
                        updateHeader();
                        appState.currentSamplePaid = true; // MARK AS PAID
                    } catch(err) { return alert("Erro ao debitar crédito: " + err.message); }
                }
            }

            const get = id => parseFloat(document.getElementById(id).value)||0;
            
            // Pegar valores dos inputs (com ou sem valor, pois Zn e B são opcionais)
            const znVal = document.getElementById('soilZn').value;
            const bVal = document.getElementById('soilB').value;

            const data = {
                owner: document.getElementById('ownerName').value,
                prop: document.getElementById('propName').value,
                season: document.getElementById('cropSeason').value,
                yield: get('targetYield'),
                prevCult: document.getElementById('prevCulture').value,
                clay: get('soilClay'), P: get('soilP'), K: get('soilK'),
                V: get('soilV'), CTC: get('soilCTC'), PRNT: get('limePRNT')||100,
                Mg: get('soilMg'),
                Ca: get('soilCa'),
                SB: get('soilSB'),
                Zn: znVal ? parseFloat(znVal) : null,
                B: bVal ? parseFloat(bVal) : null
            };

            // FUNÇÃO DE FORMATAÇÃO INTELIGENTE
            const formatSmart = (val) => {
                const num = parseFloat(val);
                if (isNaN(num)) return val;
                if (num < 10) return num.toFixed(1);
                return Math.round(num).toString();
            };

            // --- CÁLCULOS IAC 100 COMPLETOS ---
            let texClass = "";
            if (data.clay <= 20) texClass = "Arenosa";
            else if (data.clay <= 60) texClass = "Média";
            else texClass = "Argilosa";

            let nc = 0;
            if(data.V < 70) nc = ((70 - data.V) * data.CTC) / (data.PRNT * 10);
            nc = Math.max(0, nc);
            let limeType = data.Mg < 5 ? "Dolomítico (Fonte de Mg)" : "Calcítico";

            let recP = 0;
            if(texClass === "Arenosa") {
                if(data.P <= 10) recP = 80; else if(data.P <= 20) recP = 60; else if(data.P <= 30) recP = 40; else recP = 20;
            } else if(texClass === "Média") {
                if(data.P <= 10) recP = 100; else if(data.P <= 20) recP = 80; else if(data.P <= 30) recP = 60; else recP = 40;
            } else {
                if(data.P <= 10) recP = 120; else if(data.P <= 20) recP = 100; else if(data.P <= 30) recP = 80; else recP = 60;
            }

            let recK = 0;
            if(texClass === "Arenosa") {
                if(data.K <= 0.8) recK = 80; else if(data.K <= 1.5) recK = 60; else if(data.K <= 2.5) recK = 40; else recK = 20;
            } else if(texClass === "Média") {
                if(data.K <= 1.0) recK = 100; else if(data.K <= 2.0) recK = 80; else if(data.K <= 3.5) recK = 60; else recK = 40;
            } else {
                if(data.K <= 1.2) recK = 120; else if(data.K <= 2.5) recK = 100; else if(data.K <= 4.5) recK = 80; else recK = 60;
            }

            let recN = 0;
            const highYield = data.yield > 100; 
            if(data.prevCult === "milho") recN = highYield ? 80 : 60;
            else if(data.prevCult === "graminea") recN = highYield ? 100 : 80;
            else recN = highYield ? 60 : 40;

            if (data.yield > 120) recN += (data.yield - 100) * 1.0; 
            
            let warningSafra = "";
            if(data.season === 'safrinha') {
                recN *= 0.8; recK *= 0.8;
                warningSafra = " (Redução de 20% para Safrinha)";
            }

            const map = recP / 0.52; 
            const kcl = recK / 0.60; 
            const nFromMap = map * 0.11; 
            const urea = Math.max(0, recN - nFromMap) / 0.45; 
            const gessoTon = (data.clay * 50) / 1000;

            const dateStr = new Date().toLocaleDateString('pt-BR');
            
            // FORMATAÇÃO CONDICIONAL DE ZN E B PARA EXIBIÇÃO
            const znDisplay = data.Zn !== null ? `${formatSmart(data.Zn)} mg/dm³` : "Não Informado";
            const bDisplay = data.B !== null ? `${formatSmart(data.B)} mg/dm³` : "Não Informado";

            // LAUDO TEXTUAL DETALHADO REESTRUTURADO
            const laudo = `
LAUDO TÉCNICO DE RECOMENDAÇÃO AGRONÔMICA - MILHO
Base Técnica: Boletim 100 IAC (2022)
Data da Emissão: ${dateStr}
------------------------------------------------------------
1. DADOS DO PRODUTOR
Nome: ${data.owner}

2. DADOS DA PROPRIEDADE
Nome da Propriedade: ${data.prop}
Protocolo: ${document.getElementById('protocolId').value}
Safra: ${data.season.toUpperCase()}
Meta de Produtividade: ${data.yield} sacas/ha
Sistema de Cultivo: ${document.getElementById('systemType').options[document.getElementById('systemType').selectedIndex].text}
Cultura Anterior: ${document.getElementById('prevCulture').options[document.getElementById('prevCulture').selectedIndex].text}

3. DADOS ANALÍTICOS DA AMOSTRA
Argila: ${formatSmart(data.clay)}%
Fósforo (P-resina): ${formatSmart(data.P)} mg/dm³
Potássio (K): ${formatSmart(data.K)} mmolc/dm³
Cálcio (Ca): ${formatSmart(data.Ca)} mmolc/dm³
Magnésio (Mg): ${formatSmart(data.Mg)} mmolc/dm³
Soma de Bases (SB): ${formatSmart(data.SB)} mmolc/dm³
CTC (pH 7): ${formatSmart(data.CTC)} mmolc/dm³
Saturação por Bases (V%): ${formatSmart(data.V)}%
PRNT Calcário: ${formatSmart(data.PRNT)}%
Zinco (Zn): ${znDisplay}
Boro (B): ${bDisplay}

4. RECOMENDAÇÃO AGRONÔMICA

DIAGNÓSTICO:
A análise de solo (0-20 cm) apresenta uma textura ${texClass.toUpperCase()} (${formatSmart(data.clay)}% de Argila).
A saturação por bases atual (V%) é de ${formatSmart(data.V)}%. O nível crítico recomendado para a cultura do milho é 70%.

CORREÇÃO DE ACIDEZ E PERFIL:
Para elevar a saturação a 70% e neutralizar o alumínio tóxico, recomenda-se:
> CALAGEM: Aplicar ${formatSmart(nc)} toneladas por hectare de Calcário ${limeType}.
  Recomendação: Aplicar a lanço em área total e incorporar, preferencialmente 60 a 90 dias antes do plantio.

> GESSAGEM: Sugere-se a aplicação de ${formatSmart(gessoTon)} t/ha de Gesso Agrícola.
  Objetivo: Condicionamento de subsolo (fornecimento de Ca em profundidade e neutralização de Al), essencial para suportar veranicos.

PROGRAMA DE ADUBAÇÃO MINERAL (N-P-K):
Considerando a extração da cultura para a meta de ${data.yield} sc/ha e os teores do solo:
- Nitrogênio (N): ${formatSmart(recN)} kg/ha${warningSafra}
- Fósforo (P2O5): ${formatSmart(recP)} kg/ha
- Potássio (K2O): ${formatSmart(recK)} kg/ha${warningSafra}

SUGESTÃO DE MANEJO E FONTES:

A) ADUBAÇÃO DE SEMEADURA (NO SULCO)
   > ${formatSmart(map)} kg/ha de MAP (Monoamônio Fosfato)
   > ${formatSmart(kcl/2)} kg/ha de Cloreto de Potássio (KCl)
   Nota: Em solos arenosos ou se a dose de KCl for elevada (>60kg K2O), recomenda-se antecipar o potássio a lanço para evitar salinidade na semente.

B) ADUBAÇÃO DE COBERTURA
   > ${formatSmart(urea)} kg/ha de Ureia Agrícola
   > ${formatSmart(kcl/2)} kg/ha de Cloreto de Potássio (KCl) - Saldo restante

   Cronograma de Aplicação:
   - Estádio V4 (4 folhas): Aplicar 100% da cobertura em solos argilosos/médios.
   - Parcelamento em Solos Arenosos: Aplicar 50% em V4 e 50% em V8 para reduzir perdas por lixiviação.

MICRONUTRIENTES E ORGÂNICOS:
   - Zinco (Zn): Recomenda-se 300-400 g/ha via foliar (V4-V6) ou 2 kg/ha via solo.
   - Boro (B): Recomenda-se 150-200 g/ha via foliar.
   - Matéria Orgânica: Opcionalmente, pode-se usar 15-20 t/ha de esterco de curral ou 4-6 t/ha de cama de frango para melhoria da estrutura do solo.

------------------------------------------------------------
Sistema de Recomendação Agronômica (SRA)
`;

            // Exibir Resultado
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('finalReportText').value = laudo.trim();
            
            // Tabela Técnica (Valores também formatados)
            const tbody = document.getElementById('techTableBody');
            tbody.innerHTML = `
                <tr><td>Nec. Calagem</td><td>${formatSmart(nc)}</td><td>t/ha</td></tr>
                <tr><td>Nec. Gesso</td><td>${formatSmart(gessoTon)}</td><td>t/ha</td></tr>
                <tr><td>N Total</td><td>${formatSmart(recN)}</td><td>kg/ha</td></tr>
                <tr><td>P2O5 Total</td><td>${formatSmart(recP)}</td><td>kg/ha</td></tr>
                <tr><td>K2O Total</td><td>${formatSmart(recK)}</td><td>kg/ha</td></tr>
                <tr><td>MAP Estimado</td><td>${formatSmart(map)}</td><td>kg/ha</td></tr>
                <tr><td>Ureia Estimada</td><td>${formatSmart(urea)}</td><td>kg/ha</td></tr>
                <tr><td>KCl Estimado</td><td>${formatSmart(kcl)}</td><td>kg/ha</td></tr>
            `;

            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});

            // GERAR HTML PARA EXPORTAÇÃO (PDF/DOCX) COM ESTRUTURA IDÊNTICA E NOVOS CAMPOS
            // SEGURANÇA: Usando escapeHtml para prevenir XSS nos dados do usuário
            const exportHTML = `
                <div class="doc-header">
                    <h1 class="doc-title">LAUDO TÉCNICO DE RECOMENDAÇÃO AGRONÔMICA</h1>
                    <p class="doc-subtitle">SRA MILHO - Base Técnica: Boletim 100 IAC (2022)</p>
                </div>

                <div class="doc-section-title">1. DADOS DO PRODUTOR</div>
                <div class="doc-text"><strong>Nome:</strong> ${escapeHtml(data.owner)}</div>

                <div class="doc-section-title">2. DADOS DA PROPRIEDADE</div>
                <div class="doc-text">
                    <strong>Propriedade:</strong> ${escapeHtml(data.prop)}<br>
                    <strong>Protocolo:</strong> ${escapeHtml(document.getElementById('protocolId').value)}<br>
                    <strong>Safra:</strong> ${data.season.toUpperCase()} | <strong>Meta:</strong> ${data.yield} sc/ha<br>
                    <strong>Sistema:</strong> ${document.getElementById('systemType').options[document.getElementById('systemType').selectedIndex].text}<br>
                    <strong>Cultura Anterior:</strong> ${document.getElementById('prevCulture').options[document.getElementById('prevCulture').selectedIndex].text}
                </div>

                <div class="doc-section-title">3. DADOS ANALÍTICOS DA AMOSTRA</div>
                <div class="doc-text">
                    Argila: ${formatSmart(data.clay)}% | P: ${formatSmart(data.P)} mg/dm³ | K: ${formatSmart(data.K)} mmolc/dm³<br>
                    Ca: ${formatSmart(data.Ca)} mmolc/dm³ | Mg: ${formatSmart(data.Mg)} mmolc/dm³ | SB: ${formatSmart(data.SB)} mmolc/dm³<br>
                    CTC: ${formatSmart(data.CTC)} mmolc/dm³ | V%: ${formatSmart(data.V)}% | PRNT: ${formatSmart(data.PRNT)}%<br>
                    <strong>Zinco (Zn):</strong> ${znDisplay} | <strong>Boro (B):</strong> ${bDisplay}
                </div>

                <div class="doc-section-title">4. RECOMENDAÇÃO AGRONÔMICA</div>
                <div class="doc-text">
                    <strong>DIAGNÓSTICO:</strong><br>
                    A análise de solo (0-20 cm) apresenta uma textura ${texClass.toUpperCase()} (${formatSmart(data.clay)}% de Argila).
                    A saturação por bases atual (V%) é de ${formatSmart(data.V)}%. O nível crítico recomendado para a cultura do milho é 70%.<br><br>

                    <strong>CORREÇÃO DE ACIDEZ E PERFIL:</strong><br>
                    > CALAGEM: Aplicar ${formatSmart(nc)} t/ha de Calcário ${limeType}.<br>
                    > GESSAGEM: Sugere-se a aplicação de ${formatSmart(gessoTon)} t/ha de Gesso Agrícola.<br><br>

                    <strong>PROGRAMA DE ADUBAÇÃO MINERAL (N-P-K):</strong><br>
                    - Nitrogênio (N): ${formatSmart(recN)} kg/ha${warningSafra}<br>
                    - Fósforo (P2O5): ${formatSmart(recP)} kg/ha<br>
                    - Potássio (K2O): ${formatSmart(recK)} kg/ha${warningSafra}<br><br>

                    <strong>SUGESTÃO DE MANEJO E FONTES:</strong><br>
                    A) SEMEADURA: ${formatSmart(map)} kg/ha de MAP e ${formatSmart(kcl/2)} kg/ha de KCl.<br>
                    B) COBERTURA: ${formatSmart(urea)} kg/ha de Ureia e ${formatSmart(kcl/2)} kg/ha de KCl.<br><br>

                    <strong>MICRONUTRIENTES E ORGÂNICOS:</strong><br>
                    Zinco e Boro via foliar ou solo conforme disponibilidade. Uso de matéria orgânica recomendado.
                </div>

                <div class="doc-section-title">RESUMO TÉCNICO</div>
                <table class="doc-table">
                    <thead><tr><th>Parâmetro</th><th>Valor Calculado</th><th>Unidade</th></tr></thead>
                    <tbody>${tbody.innerHTML}</tbody>
                </table>

                <div class="doc-footer">
                    Documento gerado eletronicamente pelo SRA (Sistema de Recomendação Agronômica).<br>
                    Responsável Técnico: __________________________________________________
                </div>
            `;
            
            // Injeta o HTML gerado no container de exportação
            document.getElementById('exportContent').innerHTML = exportHTML;

            // GRAVAÇÃO HÍBRIDA
            const reportObj = { date: new Date().toISOString(), owner: data.owner, result: laudo };
            
            // 1. Nuvem
            if (isReal && document.getElementById('checkSaveCloud').checked && auth.currentUser) {
                try {
                    await addDoc(collection(db, "users", auth.currentUser.uid, "reports"), { ...reportObj, timestamp: serverTimestamp() });
                } catch(e) { console.error(e); }
            }
            // 2. Local
            if (document.getElementById('checkSaveLocal').checked) {
                const hist = JSON.parse(localStorage.getItem('sra_local_history')) || [];
                hist.unshift(reportObj);
                localStorage.setItem('sra_local_history', JSON.stringify(hist));
            }
        });

        // --- VISUALIZAR PDF (CORRIGIDO PARA EVITAR TELA BRANCA) ---
        window.openPdfPreview = () => {
            // Mostrar Overlay de Carregamento
            document.getElementById('pdfLoadingOverlay').style.display = 'flex';

            // 1. Clonar o conteúdo
            const originalContent = document.getElementById('exportContent');
            const element = originalContent.cloneNode(true);
            
            // 2. CORREÇÃO DEFINITIVA: 
            // - Posiciona no topo esquerdo (visível para o html2canvas, coberto pelo overlay)
            // - Define largura fixa e cores explícitas
            element.style.display = 'block';
            element.style.position = 'absolute'; // Absoluto em relação ao body
            element.style.left = '0px'; 
            element.style.top = '0px';
            element.style.width = '800px'; 
            element.style.padding = '20px';
            element.style.backgroundColor = '#ffffff'; 
            element.style.color = '#000000';
            element.style.zIndex = '9999'; // Acima do conteúdo, abaixo do overlay (10000)
            
            // 3. Anexar ao body
            document.body.appendChild(element);
            
            // 4. Opções do PDF
            const opt = {
                margin: 10,
                filename: `Laudo_${document.getElementById('ownerName').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    scrollY: 0, 
                    useCORS: true,
                    windowWidth: 800
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // 5. Delay para garantir renderização + Geração
            setTimeout(() => {
                html2pdf().set(opt).from(element).output('bloburl').then((pdfUrl) => {
                    currentPdfBlobUrl = pdfUrl; 
                    const iframe = document.getElementById('pdfPreviewFrame');
                    iframe.src = pdfUrl;
                    
                    // Remover elemento temporário e esconder loading
                    if(document.body.contains(element)) document.body.removeChild(element);
                    document.getElementById('pdfLoadingOverlay').style.display = 'none';

                    // Abrir modal
                    const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
                    modal.show();
                }).catch(err => {
                    console.error(err);
                    alert("Erro ao gerar visualização do PDF.");
                    if(document.body.contains(element)) document.body.removeChild(element);
                    document.getElementById('pdfLoadingOverlay').style.display = 'none';
                });
            }, 500); // 500ms de delay para renderização
        };

        // --- BAIXAR PDF A PARTIR DA VISUALIZAÇÃO ---
        window.downloadPdfFromPreview = () => {
            if (currentPdfBlobUrl) {
                const link = document.createElement('a');
                link.href = currentPdfBlobUrl;
                link.download = `Laudo_${document.getElementById('ownerName').value}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Erro ao baixar o PDF. Tente visualizar novamente.");
            }
        };

        // --- HISTÓRICO LOCAL ---
        window.openHistoryModal = () => {
            const list = document.getElementById('localHistoryList');
            const data = JSON.parse(localStorage.getItem('sra_local_history')) || [];
            list.innerHTML = '';
            if(data.length === 0) list.innerHTML = '<div class="text-center p-3 text-muted">Vazio</div>';
            else {
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "list-group-item list-group-item-action cursor-pointer";
                    div.innerHTML = `<div class="d-flex justify-content-between fw-bold"><span>${item.owner}</span><small>${new Date(item.date).toLocaleDateString()}</small></div>`;
                    div.onclick = () => {
                        document.getElementById('finalReportText').value = item.result;
                        document.getElementById('resultsSection').style.display = 'block';
                        bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
                    };
                    list.appendChild(div);
                });
            }
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        };

        window.clearLocalHistory = () => {
            if(confirm("Apagar histórico local?")) {
                localStorage.removeItem('sra_local_history');
                window.openHistoryModal();
            }
        };

        // --- UTILS ---
        function setStatus(title, msg, cls, icon, showReturn) {
            const el = document.getElementById('statusAlert');
            el.className = `alert shadow-sm ${cls}`;
            el.style.display = 'block';
            document.getElementById('statusTitle').innerText = title;
            document.getElementById('statusMsg').innerText = msg;
            document.getElementById('statusIcon').innerHTML = `<i class="fas ${icon}"></i>`;
            document.getElementById('returnBtnContainer').style.display = showReturn ? 'block' : 'none';
        }

        // --- EXPORTAR ---
        window.shareWhatsapp = () => window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('finalReportText').value)}`);
        
        // FUNÇÃO DE ENVIO POR E-MAIL
        window.sendEmail = () => {
            const subject = "Laudo Técnico - SRA Milho";
            const body = encodeURIComponent(document.getElementById('finalReportText').value);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        };

        // EXPORTAR WORD (.DOCX)
        window.downloadWord = () => {
            const content = document.getElementById('exportContent').innerHTML;
            const htmlString = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Laudo Técnico</title><style>body { font-family: Arial, sans-serif; } .doc-header { border-bottom: 2px solid green; margin-bottom: 20px; } .doc-section-title { background: #f0f0f0; padding: 5px; font-weight: bold; margin-top: 15px; border-left: 5px solid green; } .doc-table { width: 100%; border-collapse: collapse; } .doc-table td, .doc-table th { border: 1px solid #999; padding: 5px; }</style></head><body>${content}</body></html>`;
            if (window.htmlDocx) {
                const blob = window.htmlDocx.asBlob(htmlString, {orientation: 'portrait'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Laudo_${document.getElementById('ownerName').value}.docx`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else { alert("A biblioteca .docx ainda não carregou."); }
        };

    </script>
</body>
</html>