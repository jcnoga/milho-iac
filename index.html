<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRA Milho Profissional - Sistema Completo</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Biblioteca para DOCX (Word) -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
    <style>
        :root {
            --primary-green: #2e7d32;
            --dark-green: #1b5e20;
            --light-green: #e8f5e9;
            --accent-color: #43a047;
            --soil-brown: #795548;
        }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        
        /* Layout Principal */
        .header-app {
            background: linear-gradient(135deg, var(--dark-green) 0%, var(--primary-green) 100%);
            color: white; padding: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Estilo do Formulário (Baseado no Anexo) */
        .form-section-title {
            font-size: 1.1rem; font-weight: 700; color: #1b5e20;
            margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .card-custom {
            border: 1px solid #e0e0e0; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            background: white; padding: 25px;
        }
        
        /* Inputs Compactos */
        .form-label { font-weight: 600; font-size: 0.85rem; color: #444; margin-bottom: 3px; }
        .form-control, .form-select { 
            border: 1px solid #ccc; padding: 8px 10px; font-size: 0.95rem; border-radius: 4px; background-color: #fff;
        }
        .form-control:focus, .form-select:focus { 
            border-color: #2e7d32; box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2); 
        }
        .bg-readonly { background-color: #f2f2f2; font-weight: bold; color: #1b5e20; }
        .demo-locked { pointer-events: none; background-color: #e9ecef !important; color: #6c757d; }

        /* Botões */
        .btn-fill-purple { background-color: #6c5ce7; color: white; font-size: 0.9rem; font-weight: bold; border: none; }
        .btn-fill-purple:hover { background-color: #5b4cc4; }
        .btn-save-green { background-color: #2e7d32; color: white; font-weight: bold; border-radius: 4px; padding: 12px 30px; border: none; font-size: 1rem; }
        .btn-save-green:hover { background-color: #1b5e20; }
        .btn-clean { background-color: #fff; color: #666; border: 1px solid #ccc; font-weight: bold; border-radius: 4px; padding: 12px 30px; }

        /* Auth & Modais */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.98); z-index: 9999;
            display: flex; align-items: center; justify-content: center; overflow-y: auto;
        }
        .auth-card {
            background: white; padding: 2.5rem; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 480px;
        }

        /* Relatórios Tela */
        .report-box {
            font-family: 'Segoe UI', sans-serif; white-space: pre-wrap; background: #fff;
            border: 1px solid #ced4da; padding: 30px; border-radius: 8px;
            font-size: 0.95rem; line-height: 1.6; color: #212529;
        }
        .table-tech th { background-color: var(--light-green); color: var(--dark-green); }

        /* --- ESTILOS DO DOCUMENTO EXPORTADO (WORD) --- */
        #exportContent { display: none; }
        .doc-header { border-bottom: 3px solid #1b5e20; margin-bottom: 20px; padding-bottom: 10px; }
        .doc-title { font-size: 22px; font-weight: bold; color: #1b5e20; margin: 0; }
        .doc-subtitle { font-size: 11px; color: #555; }
        .doc-section-title { 
            background-color: #e8f5e9; color: #1b5e20; padding: 5px; 
            font-weight: bold; font-size: 12px; margin-top: 15px; border-left: 5px solid #1b5e20; 
        }
        .doc-text { font-size: 11px; text-align: justify; margin-top: 5px; line-height: 1.4; white-space: pre-wrap; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10px; }
        .doc-table th { background-color: #e8f5e9; border: 1px solid #ccc; padding: 5px; }
        .doc-table td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .doc-footer { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 5px; text-align: center; font-size: 9px; color: #777; }
    </style>
</head>
<body>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="authScreen" class="auth-overlay">
        <!-- Login -->
        <div id="loginForm" class="auth-card">
            <div class="text-center mb-4">
                <i class="fas fa-leaf text-success fa-4x"></i>
                <h3 class="fw-bold mt-3">SRA Milho</h3>
                <p class="text-muted">Acesso Profissional</p>
            </div>
            <div class="mb-3"><label class="form-label">E-mail</label><input type="email" id="loginEmail" class="form-control"></div>
            <div class="mb-4"><label class="form-label">Senha</label><input type="password" id="loginPass" class="form-control"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg fw-bold" id="btnLoginAction">ENTRAR</button>
                <button class="btn btn-outline-dark" id="btnGoogleAction"><i class="fab fa-google me-2"></i> Google</button>
            </div>
            <div class="text-center mt-4">
                <a href="#" class="text-decoration-none me-3" onclick="toggleAuth('register')">Criar Conta</a>
                <a href="#" class="text-decoration-none ms-3 text-muted" onclick="toggleAuth('forgot')">Recuperar Senha</a>
            </div>
        </div>
        
        <!-- Cadastro -->
        <div id="registerForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-4">Nova Conta</h4>
            <div class="mb-3"><label>Nome Completo</label><input type="text" id="regName" class="form-control"></div>
            <div class="mb-3"><label>E-mail</label><input type="email" id="regEmail" class="form-control"></div>
            <div class="mb-4"><label>Senha</label><input type="password" id="regPass" class="form-control"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary fw-bold" id="btnRegAction">CADASTRAR</button>
                <button class="btn btn-link" onclick="toggleAuth('login')">Voltar</button>
            </div>
        </div>

        <!-- Recuperar Senha -->
        <div id="forgotForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold mb-3">Recuperar Senha</h4>
            <div class="mb-4"><label>E-mail</label><input type="email" id="forgotEmail" class="form-control"></div>
            <div class="d-grid gap-2"><button class="btn btn-warning text-white fw-bold" id="btnForgotAction">ENVIAR EMAIL</button><button class="btn btn-link" onclick="toggleAuth('login')">Voltar</button></div>
        </div>

        <!-- Token -->
        <div id="tokenForm" class="auth-card" style="display:none;">
            <h4 class="text-center fw-bold text-primary mb-2">Créditos</h4>
            <div class="bg-light p-3 rounded text-center mb-4 border"><h1 class="text-dark m-0" id="displayAuthCode">----</h1></div>
            <div class="mb-3"><input type="text" id="inputToken" class="form-control text-center form-control-lg" placeholder="Senha"></div>
            <div class="d-grid gap-2"><button class="btn btn-success fw-bold" id="btnTokenAction">VALIDAR</button><button class="btn btn-link text-danger" onclick="startUnauthorized()">Modo Demonstração</button></div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="appContainer" style="display: none;">
        
        <header class="header-app sticky-top">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-signature fa-lg me-2"></i>
                    <div><h5 class="m-0 fw-bold">Amostras de Solo</h5><small class="text-white-50">Cadastro e Interpretação</small></div>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-white text-success p-2 shadow-sm me-3"><i class="fas fa-coins"></i> <span id="creditCounter">...</span></span>
                    <button class="btn btn-outline-light btn-sm me-2 fw-bold" onclick="openHistoryModal()">Histórico</button>
                    <div class="dropdown me-2">
                        <button class="btn btn-sm btn-light dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown"><i class="fas fa-user-circle"></i> <span id="userNameDisplay">User</span></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="showTokenScreen()">Adicionar Créditos</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-danger fw-bold" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </header>

        <div class="container mt-4 pb-5">
            <!-- Barra de Status -->
            <div id="statusAlert" class="alert shadow-sm border-2" style="display: none;">
                <div class="d-flex align-items-center">
                    <div class="fs-2 me-3" id="statusIcon"></div>
                    <div><h6 class="fw-bold m-0" id="statusTitle"></h6><p class="m-0 small" id="statusMsg"></p></div>
                    <div class="ms-auto" id="returnBtnContainer" style="display:none;"><button class="btn btn-danger btn-sm fw-bold" onclick="resetToRealMode()">Cancelar</button></div>
                </div>
            </div>

            <!-- Formulário Completo (Estilo Anexo) -->
            <div class="card-custom">
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-fill-purple" onclick="triggerExampleData()"><i class="fas fa-magic me-1"></i> Preencher Teste</button>
                </div>

                <form id="agronomicForm">
                    <!-- 1. Dados Gerais -->
                    <div class="mb-4">
                        <h5 class="form-section-title">1. Dados Gerais</h5>
                        <div class="row g-2">
                            <div class="col-md-6"><label class="form-label">Produtor</label><input type="text" class="form-control" id="ownerName"></div>
                            <div class="col-md-6"><label class="form-label">Propriedade</label><input type="text" class="form-control" id="propName"></div>
                            <div class="col-md-6"><label class="form-label">Município/UF</label><input type="text" class="form-control" id="cityState"></div>
                            <div class="col-md-6"><label class="form-label">Resp. Técnico</label><input type="text" class="form-control" id="techResp"></div>
                            <div class="col-md-12"><label class="form-label">Cultivo Anterior</label><select class="form-select" id="prevCulture"><option value="milho">Milho</option><option value="graminea">Gramínea/Pastagem</option><option value="leguminosa">Leguminosa (Soja/Feijão)</option></select></div>
                        </div>
                    </div>

                    <!-- 2. Identificação e Cultura -->
                    <div class="mb-4">
                        <h5 class="form-section-title">2. Identificação e Cultura</h5>
                        <div class="row g-2">
                            <div class="col-md-3"><label class="form-label">Protocolo</label><input type="text" class="form-control" id="protocolId"></div>
                            <div class="col-md-3"><label class="form-label">Talhão</label><input type="text" class="form-control" id="plotId"></div>
                            <div class="col-md-3"><label class="form-label">Profundidade</label><input type="text" class="form-control" value="0-20"></div>
                            <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" id="sampleDate"></div>
                            
                            <div class="col-md-3"><label class="form-label">Cultura Atual</label><select class="form-select" id="cropSeason"><option value="verao">Milho Verão</option><option value="safrinha">Milho Safrinha</option></select></div>
                            <div class="col-md-3"><label class="form-label">Produtividade (sc/ha)</label><input type="number" class="form-control" id="targetYield"></div>
                            <div class="col-md-3"><label class="form-label">Esp. Linha (m)</label><input type="number" class="form-control" value="0.50" step="0.01"></div>
                            <div class="col-md-3"><label class="form-label">Esp. Cova (m)</label><input type="number" class="form-control" value="0.20" step="0.01"></div>
                            <div class="col-md-12"><label class="form-label">Sistema de Plantio</label><select class="form-select" id="systemType"><option value="spd_consolidado">Plantio Direto</option><option value="conv">Convencional</option></select></div>
                        </div>
                    </div>

                    <!-- 3. Análise Química -->
                    <div class="mb-4">
                        <h5 class="form-section-title">3. Análise Química</h5>
                        <div class="row g-2">
                            <div class="col-md-3"><label class="form-label">pH (H₂O)</label><input type="number" class="form-control" id="soilPH" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">M.O. (%)</label><input type="number" class="form-control" id="soilMO" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">P-resina (mg/dm³)</label><input type="number" class="form-control" id="soilP" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">S (mg/dm³)</label><input type="number" class="form-control" id="soilS" step="0.1"></div>
                            
                            <!-- Bases e Acidez -->
                            <div class="col-md-3"><label class="form-label">Ca (cmolc/dm³)</label><input type="number" class="form-control" id="soilCa" step="0.1" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">Mg (cmolc/dm³)</label><input type="number" class="form-control" id="soilMg" step="0.1" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">K (cmolc/dm³)</label><input type="number" class="form-control" id="soilK" step="0.01" oninput="calculateComplex()"></div>
                            <div class="col-md-3"><label class="form-label">H+Al (cmolc/dm³)</label><input type="number" class="form-control" id="soilHAl" step="0.1" oninput="calculateComplex()"></div>
                            
                            <div class="col-md-3"><label class="form-label">Al (cmolc/dm³)</label><input type="number" class="form-control" id="soilAl" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label bg-readonly">CTC (Calc)</label><input type="number" class="form-control bg-readonly" id="soilCTC" readonly></div>
                            <div class="col-md-3"><label class="form-label bg-readonly">V% (Calc)</label><input type="number" class="form-control bg-readonly" id="soilV" readonly></div>
                            <div class="col-md-3"><label class="form-label">PRNT Calcário</label><input type="number" class="form-control" id="limePRNT" value="80"></div>
                        </div>
                    </div>

                    <!-- 4. Física e Micronutrientes -->
                    <div class="mb-4">
                        <h5 class="form-section-title">4. Física e Micronutrientes</h5>
                        <div class="row g-2">
                            <div class="col-md-3"><label class="form-label">Argila %</label><input type="number" class="form-control" id="soilClay" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Areia %</label><input type="number" class="form-control" id="soilSand" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Zn (mg/dm³)</label><input type="number" class="form-control" id="soilZn" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">B (mg/dm³)</label><input type="number" class="form-control" id="soilB" step="0.1"></div>
                            
                            <div class="col-md-3"><label class="form-label">Mn (mg/dm³)</label><input type="number" class="form-control" id="soilMn" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Cu (mg/dm³)</label><input type="number" class="form-control" id="soilCu" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Fe (mg/dm³)</label><input type="number" class="form-control" id="soilFe" step="0.1"></div>
                            <div class="col-md-3"><label class="form-label">Mo (mg/dm³)</label><input type="number" class="form-control" id="soilMo" step="0.01"></div>
                        </div>
                    </div>

                    <!-- Opções Híbridas -->
                    <div class="d-flex gap-3 mb-3 small text-muted bg-light p-2 rounded justify-content-center">
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkSaveCloud" checked><label class="form-check-label">Salvar Nuvem (Firebase)</label></div>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkSaveLocal" checked><label class="form-check-label">Salvar Local (Offline)</label></div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="d-flex gap-2">
                        <button type="button" id="btnCalculate" class="btn-save-green" onclick="generateRecommendation()">Salvar Amostra e Gerar Laudo</button>
                        <button type="button" class="btn-clean" onclick="resetToRealMode()">Limpar Tela</button>
                    </div>
                </form>
            </div>

            <!-- RESULTADOS -->
            <div id="resultsSection" style="display: none;">
                <div class="card card-custom border-top border-3 border-success">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-success m-0">Laudo Técnico Gerado</h5>
                    </div>
                    <ul class="nav nav-pills mb-3" id="pills-tab">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-laudo">Recomendação</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-tabela">Tabela Técnica</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="pills-laudo">
                            <textarea id="finalReportText" class="form-control report-box shadow-sm mb-3" rows="18" readonly></textarea>
                            <div class="row g-2">
                                <div class="col-md-6"><button class="btn btn-success w-100 fw-bold" onclick="shareWhatsapp()"><i class="fab fa-whatsapp me-2"></i> WhatsApp</button></div>
                                <div class="col-md-6"><button class="btn btn-primary w-100 fw-bold" onclick="downloadWord()"><i class="fas fa-file-word me-2"></i> Baixar Word (.docx)</button></div>
                                <div class="col-12 mt-2"><button class="btn btn-secondary w-100 fw-bold" onclick="printPDF()"><i class="fas fa-print me-2"></i> Imprimir / Salvar PDF (Nativo)</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-tabela">
                            <table class="table table-bordered table-striped text-center table-tech"><thead class="table-success"><tr><th>Parâmetro</th><th>Valor Calculado</th><th>Unidade</th></tr></thead><tbody id="techTableBody"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Histórico Local</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="localHistoryList" class="list-group"></div></div><div class="modal-footer"><button class="btn btn-outline-danger btn-sm" onclick="clearLocalHistory()">Limpar</button></div></div></div></div>

    <!-- TEMPLATE EXPORTAÇÃO (WORD) -->
    <div id="exportContent">
        <div class="doc-header"><h1 class="doc-title">LAUDO TÉCNICO DE RECOMENDAÇÃO AGRONÔMICA</h1><p class="doc-subtitle">SRA MILHO - Base Técnica: Boletim 100 IAC (2022)</p></div>
        <div class="doc-section-title">1. IDENTIFICAÇÃO E DIAGNÓSTICO</div>
        <div class="doc-text">
            <strong>Produtor:</strong> <span id="doc_owner"></span> | <strong>Propriedade:</strong> <span id="doc_prop"></span><br>
            <strong>Safra:</strong> <span id="doc_season"></span> | <strong>Meta:</strong> <span id="doc_yield"></span> sc/ha<br>
            <strong>Solo:</strong> Classe Textural <span id="doc_texture"></span> (<span id="doc_clay"></span>% Argila) | V%: <span id="doc_v"></span>
        </div>
        <div class="doc-section-title">2. CORREÇÃO E NUTRIÇÃO</div>
        <div class="doc-text" id="doc_body_content"></div>
        <div class="doc-section-title">3. RESUMO TÉCNICO</div>
        <div id="doc_table_container"></div>
        <div class="doc-footer">Documento gerado eletronicamente pelo SRA (Sistema de Recomendação Agronômica).</div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG FIREBASE (RECOLOQUE SUAS CHAVES AQUI)
        const firebaseConfig = {
            apiKey: "AIzaSyB5LjcVrlnBSTQyzbj1PxOFoO176KnHdZs",
            authDomain: "milho-iac.firebaseapp.com",
            projectId: "milho-iac",
            storageBucket: "milho-iac.firebasestorage.app",
            messagingSenderId: "1072500431786",
            appId: "1:1072500431786:web:7b9ac660aa47f6433969d3",
            measurementId: "G-07R2DFGE8T"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch(e){ console.warn("Firebase config missing"); }

        let currentUserData = null;
        let appState = { isDemo: false, isFreeExample: false, generatedCode: null };

        const els = {
            authScreen: document.getElementById('authScreen'), appContainer: document.getElementById('appContainer'),
            loginForm: document.getElementById('loginForm'), regForm: document.getElementById('registerForm'), tokenForm: document.getElementById('tokenForm'), forgotForm: document.getElementById('forgotForm'),
            creditCounter: document.getElementById('creditCounter'), userName: document.getElementById('userNameDisplay'), btnCalc: document.getElementById('btnCalculate')
        };

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if(user){
                const snap = await getDoc(doc(db,"users",user.uid));
                currentUserData = snap.exists() ? snap.data() : {name:user.email.split('@')[0], email:user.email, credits:3};
                if(!snap.exists()) await setDoc(doc(db,"users",user.uid), currentUserData);
                showAppUI();
            } else { currentUserData=null; showAuthUI('login'); }
        });

        window.toggleAuth=(s)=>{ ['loginForm','registerForm','tokenForm','forgotForm'].forEach(i=>document.getElementById(i).style.display='none'); document.getElementById(s+'Form').style.display='block'; };
        window.startUnauthorized=()=>{ appState.isDemo=true; showAppUI(); setStatus("DEMO", "Visualização", "alert-danger", "fa-ban", false); triggerExampleData(); };
        window.handleLogout=()=>{ if(confirm("Sair?")) signOut(auth).then(()=>location.reload()); };

        // Listeners
        document.getElementById('btnLoginAction').addEventListener('click',()=>signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(e=>alert(e.message)));
        document.getElementById('btnRegAction').addEventListener('click',()=>createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value).then(c=>setDoc(doc(db,"users",c.user.uid),{name:document.getElementById('regName').value,email:c.user.email,credits:3})).catch(e=>alert(e.message)));
        document.getElementById('btnGoogleAction').addEventListener('click',()=>signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>console.error(e)));
        document.getElementById('btnForgotAction').addEventListener('click',()=>sendPasswordResetEmail(auth, document.getElementById('forgotEmail').value).then(()=>alert("Verifique e-mail")).catch(e=>alert(e.message)));

        // UI
        function showAppUI(){ els.authScreen.style.display='none'; els.appContainer.style.display='block'; updateHeader(); }
        function showAuthUI(s){ els.authScreen.style.display='flex'; els.appContainer.style.display='none'; toggleAuth(s); }
        function updateHeader(){ 
            els.creditCounter.innerText = appState.isDemo ? "DEMO" : currentUserData?.credits; 
            els.userName.innerText = appState.isDemo ? "Visitante" : currentUserData?.name;
        }

        // Tokens
        window.showTokenScreen = () => { els.appContainer.style.display='none'; els.authScreen.style.display='flex'; toggleAuth('token'); appState.generatedCode=Math.floor(Math.random()*9000)+1000; document.getElementById('displayAuthCode').innerText=appState.generatedCode; };
        document.getElementById('btnTokenAction').addEventListener('click', async()=>{
            const inp = document.getElementById('inputToken').value.replace(/\D/g,'');
            if(inp.length<6) return alert("Inválido");
            const exp = (appState.generatedCode+13)*9+1954;
            if(parseInt(inp.substring(0,5))===exp && parseInt(inp.substring(5))>0) {
                await updateDoc(doc(db,"users",auth.currentUser.uid),{credits:increment(parseInt(inp.substring(5)))});
                currentUserData = (await getDoc(doc(db,"users",auth.currentUser.uid))).data();
                alert("Sucesso!"); showAppUI();
            } else alert("Senha incorreta");
        });

        // --- CÁLCULOS COMPLEXOS DE SOLO (SOMA DE BASES E CTC) ---
        window.calculateComplex = () => {
            const get = id => parseFloat(document.getElementById(id).value)||0;
            const K = get('soilK');
            const Ca = get('soilCa');
            const Mg = get('soilMg');
            const HAl = get('soilHAl'); // Acidez Potencial

            const SB = Ca + Mg + K; 
            const CTC = SB + HAl;
            const V = CTC > 0 ? (SB / CTC) * 100 : 0;

            document.getElementById('soilCTC').value = CTC.toFixed(2);
            document.getElementById('soilV').value = V.toFixed(1);
        };

        window.triggerExampleData = () => {
            appState.isFreeExample=true; setStatus("SIMULAÇÃO", "Dados fictícios", "alert-warning", "fa-magic", true);
            const r = (min,max)=>(Math.random()*(max-min)+min).toFixed(1);
            document.getElementById('ownerName').value="Produtor Teste";
            document.getElementById('targetYield').value=150;
            document.getElementById('soilClay').value=r(20,50);
            document.getElementById('soilP').value=r(10,40);
            document.getElementById('soilK').value=r(0.1, 0.5); 
            document.getElementById('soilCa').value=r(2, 6); 
            document.getElementById('soilMg').value=r(0.5, 2); 
            document.getElementById('soilHAl').value=r(2, 5); 
            window.calculateComplex();
            
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el=>{el.readOnly=true; el.classList.add('demo-locked');});
            els.btnCalc.innerHTML="SALVAR (SIMULAÇÃO)";
        };

        window.resetToRealMode = () => {
            appState.isFreeExample=false; document.getElementById('statusAlert').style.display='none';
            document.querySelectorAll('#agronomicForm input, #agronomicForm select').forEach(el=>{el.readOnly=false; el.classList.remove('demo-locked'); el.value=''; if(el.id==='limePRNT')el.value=80;});
            els.btnCalc.innerHTML='Salvar Amostra';
            document.getElementById('resultsSection').style.display='none';
        };

        // --- GERAÇÃO E LÓGICA IAC 100 COMPLETA E DETALHADA ---
        document.getElementById('btnCalculate').addEventListener('click', async (e) => {
            const isReal = !appState.isDemo && !appState.isFreeExample;
            if(isReal) {
                if(!currentUserData || currentUserData.credits<=0) return alert("Sem créditos.");
                try { await updateDoc(doc(db,"users",auth.currentUser.uid),{credits:increment(-1)}); currentUserData.credits--; updateHeader(); } catch(e){return alert("Erro rede");}
            }

            const get = id => parseFloat(document.getElementById(id).value)||0;
            const data = {
                owner: document.getElementById('ownerName').value,
                prop: document.getElementById('propName').value,
                season: document.getElementById('cropSeason').value,
                yield: get('targetYield'),
                clay: get('soilClay'), P: get('soilP'),
                K: get('soilK') * 10, // cmolc -> mmolc para tabela
                V: get('soilV'), CTC: get('soilCTC') * 10, // mmolc
                PRNT: get('limePRNT')||100, Mg: get('soilMg') * 10 // mmolc
            };

            // 1. Calagem (Fórmula IAC)
            // NC = (V2 - V1) * CTC / PRNT. (Para resultado em t/ha, se CTC em mmol/dm3, divide por 10)
            let nc = Math.max(0, data.V < 70 ? ((70 - data.V) * data.CTC) / (10 * data.PRNT) : 0);
            let limeType = data.Mg < 5 ? "Dolomítico (Fonte de Mg)" : "Calcítico";
            
            // 2. Classificação Textural
            let texClass = "";
            if (data.clay <= 20) texClass = "Arenosa";
            else if (data.clay <= 60) texClass = "Média";
            else texClass = "Argilosa";

            // 3. Fósforo (IAC Tabela 1 Completa)
            let recP = 0;
            if(texClass === "Arenosa") {
                if(data.P <= 10) recP = 80; else if(data.P <= 20) recP = 60; else if(data.P <= 30) recP = 40; else recP = 20;
            } else if(texClass === "Média") {
                if(data.P <= 10) recP = 100; else if(data.P <= 20) recP = 80; else if(data.P <= 30) recP = 60; else recP = 40;
            } else { // Argilosa
                if(data.P <= 10) recP = 120; else if(data.P <= 20) recP = 100; else if(data.P <= 30) recP = 80; else recP = 60;
            }

            // 4. Potássio (IAC Tabela 1 Completa - K em mmolc)
            let recK = 0;
            if(texClass === "Arenosa") {
                if(data.K <= 0.8) recK = 80; else if(data.K <= 1.5) recK = 60; else if(data.K <= 2.5) recK = 40; else recK = 20;
            } else if(texClass === "Média") {
                if(data.K <= 1.0) recK = 100; else if(data.K <= 2.0) recK = 80; else if(data.K <= 3.5) recK = 60; else recK = 40;
            } else { // Argilosa
                if(data.K <= 1.2) recK = 120; else if(data.K <= 2.5) recK = 100; else if(data.K <= 4.5) recK = 80; else recK = 60;
            }

            // 5. Nitrogênio (IAC Tabela 2 Completa - Baseado em meta e cultura anterior)
            let recN = 0;
            const highYield = data.yield > 100; // > 100 sc/ha (6t)
            const prevCulture = document.getElementById('prevCulture').value;
            
            if(prevCulture === "milho") recN = highYield ? 80 : 60;
            else if(prevCulture === "graminea") recN = highYield ? 100 : 80;
            else recN = highYield ? 60 : 40; // Leguminosa

            // Ajuste Prático de Alta Produtividade: +1.2kg N por saca extra acima de 100
            if (data.yield > 100) {
                let extraN = (data.yield - 100) * 1.2;
                recN += extraN;
            }

            // Ajuste Safrinha
            let warningSafra = "";
            if(data.season === 'safrinha') {
                recN *= 0.8; recK *= 0.8;
                warningSafra = " (Redução de 20% aplicada para Safrinha)";
            }

            // Fontes Comerciais
            const map = recP / 0.52; // 52% P2O5
            const kcl = recK / 0.60; // 60% K2O
            const nFromMap = map * 0.11; // 11% N
            const urea = Math.max(0, recN - nFromMap) / 0.45; // 45% N
            const gessoTon = (data.clay * 50) / 1000; // NG = 50 * Argila

            const dateStr = new Date().toLocaleDateString('pt-BR');
            
            // LAUDO TEXTUAL DETALHADO
            const laudo = `
LAUDO TÉCNICO DE RECOMENDAÇÃO AGRONÔMICA - MILHO
Base Técnica: Boletim 100 IAC (2022)
Data da Emissão: ${dateStr}
------------------------------------------------------------
DADOS CADASTRAIS
Produtor: ${data.owner}
Propriedade: ${data.prop}
Safra de Cultivo: ${data.season.toUpperCase()}
Meta de Produtividade: ${data.yield} sacas/ha

1. DIAGNÓSTICO DA FERTILIDADE
A análise de solo (0-20 cm) apresenta uma textura ${texClass.toUpperCase()} (${data.clay}% de Argila).
A saturação por bases atual (V%) é de ${data.V.toFixed(1)}%. O nível crítico recomendado para a cultura do milho é 70%.

2. CORREÇÃO DE ACIDEZ E PERFIL
Para elevar a saturação a 70% e neutralizar o alumínio tóxico, recomenda-se:
> CALAGEM: Aplicar ${nc.toFixed(1)} toneladas por hectare de Calcário ${limeType}.
  Recomendação: Aplicar a lanço em área total e incorporar, preferencialmente 60 a 90 dias antes do plantio.

> GESSAGEM: Sugere-se a aplicação de ${gessoTon.toFixed(1)} t/ha de Gesso Agrícola.
  Objetivo: Condicionamento de subsolo (fornecimento de Ca em profundidade e neutralização de Al), essencial para suportar veranicos.

3. PROGRAMA DE ADUBAÇÃO MINERAL (N-P-K)
Considerando a extração da cultura para a meta de ${data.yield} sc/ha e os teores do solo:
- Nitrogênio (N): ${recN.toFixed(0)} kg/ha${warningSafra}
- Fósforo (P2O5): ${recP} kg/ha
- Potássio (K2O): ${recK.toFixed(0)} kg/ha${warningSafra}

SUGESTÃO DE MANEJO E FONTES:

A) ADUBAÇÃO DE SEMEADURA (NO SULCO)
   > ${Math.round(map)} kg/ha de MAP (Monoamônio Fosfato)
   > ${Math.round(kcl/2)} kg/ha de Cloreto de Potássio (KCl)
   Nota: Em solos arenosos ou se a dose de KCl for elevada (>60kg K2O), recomenda-se antecipar o potássio a lanço para evitar salinidade na semente.

B) ADUBAÇÃO DE COBERTURA
   > ${Math.round(urea)} kg/ha de Ureia Agrícola
   > ${Math.round(kcl/2)} kg/ha de Cloreto de Potássio (KCl) - Saldo restante

   Cronograma de Aplicação:
   - Estádio V4 (4 folhas): Aplicar 100% da cobertura em solos argilosos/médios.
   - Parcelamento em Solos Arenosos: Aplicar 50% em V4 e 50% em V8 para reduzir perdas por lixiviação.

4. MICRONUTRIENTES E ORGÂNICOS
   - Zinco (Zn): Recomenda-se 300-400 g/ha via foliar (V4-V6) ou 2 kg/ha via solo.
   - Boro (B): Recomenda-se 150-200 g/ha via foliar.
   - Matéria Orgânica: Opcionalmente, pode-se usar 15-20 t/ha de esterco de curral ou 4-6 t/ha de cama de frango para melhoria da estrutura do solo.

------------------------------------------------------------
Sistema de Recomendação Agronômica (SRA)
`;

            // Exibir Resultado
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('finalReportText').value = laudo.trim();
            
            // Tabela Técnica
            const tbody = document.getElementById('techTableBody');
            tbody.innerHTML = `
                <tr><td>Nec. Calagem</td><td>${nc.toFixed(1)}</td><td>t/ha</td></tr>
                <tr><td>Nec. Gesso</td><td>${gessoTon.toFixed(1)}</td><td>t/ha</td></tr>
                <tr><td>N Total</td><td>${recN.toFixed(0)}</td><td>kg/ha</td></tr>
                <tr><td>P2O5 Total</td><td>${recP}</td><td>kg/ha</td></tr>
                <tr><td>K2O Total</td><td>${recK.toFixed(0)}</td><td>kg/ha</td></tr>
                <tr><td>MAP Estimado</td><td>${Math.round(map)}</td><td>kg/ha</td></tr>
                <tr><td>Ureia Estimada</td><td>${Math.round(urea)}</td><td>kg/ha</td></tr>
                <tr><td>KCl Estimado</td><td>${Math.round(kcl)}</td><td>kg/ha</td></tr>
            `;

            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});

            // Preencher dados do Export Oculto (DOC)
            document.getElementById('doc_owner').innerText = data.owner;
            document.getElementById('doc_prop').innerText = data.prop;
            document.getElementById('doc_season').innerText = data.season.toUpperCase();
            document.getElementById('doc_yield').innerText = data.yield;
            document.getElementById('doc_texture').innerText = texClass;
            document.getElementById('doc_clay').innerText = data.clay;
            document.getElementById('doc_v').innerText = data.V.toFixed(1);
            document.getElementById('doc_body_content').innerText = laudo.substring(laudo.indexOf("2. CORREÇÃO"));
            // Copiar tabela para o doc
            document.getElementById('doc_table_container').innerHTML = `
                <table class="doc-table">
                    <thead><tr><th>Parâmetro</th><th>Valor Calculado</th><th>Unidade</th></tr></thead>
                    <tbody>${tbody.innerHTML}</tbody>
                </table>
            `;

            // GRAVAÇÃO HÍBRIDA
            const reportObj = { date: new Date().toISOString(), owner: data.owner, result: laudo };
            
            // 1. Nuvem
            if (isReal && document.getElementById('checkSaveCloud').checked && auth.currentUser) {
                try {
                    await addDoc(collection(db, "users", auth.currentUser.uid, "reports"), { ...reportObj, timestamp: serverTimestamp() });
                } catch(e) { console.error(e); }
            }
            // 2. Local
            if (document.getElementById('checkSaveLocal').checked) {
                const hist = JSON.parse(localStorage.getItem('sra_local_history')) || [];
                hist.unshift(reportObj);
                localStorage.setItem('sra_local_history', JSON.stringify(hist));
            }
        });

        // Utils
        function setStatus(t,m,c,i,r){const e=document.getElementById('statusAlert');e.className=`alert shadow-sm ${c}`;e.style.display='block';document.getElementById('statusTitle').innerText=t;document.getElementById('statusMsg').innerText=m;document.getElementById('statusIcon').innerHTML=`<i class="fas ${i}"></i>`;document.getElementById('returnBtnContainer').style.display=r?'block':'none';}
        window.shareWhatsapp=()=>window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('finalReportText').value)}`);
        window.shareEmail=()=>location.href=`mailto:?body=${encodeURIComponent(document.getElementById('finalReportText').value)}`;
        
        window.openHistoryModal=()=>{
            const l=document.getElementById('localHistoryList'), d=JSON.parse(localStorage.getItem('sra_local_history'))||[];
            l.innerHTML=''; if(!d.length)l.innerHTML='<div class="p-3 text-center text-muted">Vazio</div>';
            else d.forEach(i=>{ const x=document.createElement('div'); x.className="list-group-item list-group-item-action"; x.innerHTML=`<b>${i.owner}</b> <small>${new Date(i.date).toLocaleDateString()}</small>`; x.onclick=()=>{document.getElementById('finalReportText').value=i.result; document.getElementById('resultsSection').style.display='block'; bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();}; l.appendChild(x); });
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        };
        window.clearLocalHistory=()=>{ if(confirm("Apagar?")){localStorage.removeItem('sra_local_history'); window.openHistoryModal();} };

        // Export DOCX (.docx real)
        window.downloadWord = () => {
            const content = document.getElementById('exportContent').innerHTML;
            const htmlContent = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>body{font-family:'Calibri',sans-serif;font-size:11pt} h1{color:#2e7d32;font-size:16pt;margin-bottom:5px} p{margin-bottom:10px} table{width:100%;border-collapse:collapse;margin-top:15px} th,td{border:1px solid #ccc;padding:5px;text-align:center} th{background-color:#f2f2f2}</style></head><body>${content}</body></html>`;
            if (typeof htmlDocx !== 'undefined') {
                const converted = htmlDocx.asBlob(htmlContent);
                const link = document.createElement('a'); link.href = URL.createObjectURL(converted);
                link.download = `Laudo_${document.getElementById('ownerName').value || 'SRA'}.docx`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else { alert("Erro ao carregar biblioteca DOCX. Verifique a internet."); }
        };

        // Export PDF (Nativo / Janela de Impressão)
        window.printPDF = () => {
            const content = document.getElementById('exportContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Laudo Agronômico</title><style>body{font-family:Arial,sans-serif;padding:40px} .doc-header{border-bottom:3px solid #1b5e20;margin-bottom:20px} .doc-section-title{background:#f0f0f0;border-left:5px solid #1b5e20;padding:10px;font-weight:bold;margin-top:20px} .doc-table{width:100%;border-collapse:collapse;margin-top:10px} .doc-table td, .doc-table th{border:1px solid #999;padding:8px} .doc-text{text-align:justify;line-height:1.5;white-space:pre-wrap}</style></head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        };

    </script>
</body>
</html>